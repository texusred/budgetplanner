<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Budget Planner</title>
    <!-- Add jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Add js-cookie library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header-container {
            display: flex;
            align-items: center;
            width: 100%;
            margin-bottom: 20px;
            text-align: left;
        }

        .logo {
            height: 40px; /* Adjust size as needed */
            margin-right: 15px;
        }       

        .header-container h1 {
            margin: 0;
            text-align: center;
            width: 100%;
        }
        .card {
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
        }
        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .delete-btn {
            background-color: #f44336;
        }
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        .summary-table {
            background-color: #f8f9fa;
        }
        .positive {
            color: green;
            font-weight: bold;
        }
        .negative {
            color: red;
            font-weight: bold;
        }
        .ticket-scenarios {
            display: flex;
            margin-bottom: 15px;
        }
        .scenario-control {
            margin-right: 15px;
        }
        .attendance-row {
            background-color: #e9f7ef;
        }
        .total-row {
            background-color: #eaf2f8;
            font-weight: bold;
        }
        .tabs {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 5px 5px 0 0;
        }
        .tab-button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            margin: 0;
            color: black;
        }
        .tab-button:hover {
            background-color: #ddd;
        }
        .tab-button.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
            animation: fadeEffect 1s;
        }
        @keyframes fadeEffect {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .save-btn {
            background-color: #2196F3;
        }
        .save-btn:hover {
            background-color: #0b7dda;
        }
        .load-btn {
            background-color: #ff9800;
        }
        .load-btn:hover {
            background-color: #e68a00;
        }
        .export-btn {
            background-color: #9c27b0;
        }
        .export-btn:hover {
            background-color: #7b1fa2;
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
            z-index: 100;
        }
        @media print {
            button, .no-print {
                display: none;
            }
        }
        /* Add this to your existing CSS styles */

/* Responsive styles for mobile */
@media screen and (max-width: 768px) {
    /* General container adjustments */
    .container {
        padding: 10px;
        width: 100%;
    }
    
    /* Header adjustments */
    .header-container {
        flex-direction: column;
        text-align: center;
    }
    
    .header-container h1 {
        font-size: 1.5rem;
        margin-top: 10px;
    }
    
    /* Tab buttons adjustments */
    .tabs {
        display: flex;
        flex-wrap: wrap;
    }
    
    .tab-button {
        flex: 1 0 auto;
        min-width: 100px;
        font-size: 0.9rem;
        padding: 10px 5px;
    }
    
    /* Table adjustments for mobile */
    table, thead, tbody, th, td, tr {
        display: block;
    }
    
    thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
    }
    
    tr {
        margin-bottom: 15px;
        border: 1px solid #ccc;
    }
    
    td {
        position: relative;
        padding-left: 40%;
        border: none;
        border-bottom: 1px solid #eee;
    }
    
    td:before {
        position: absolute;
        left: 10px;
        width: 35%;
        white-space: nowrap;
        font-weight: bold;
    }
    
    /* Add data labels for each table type */
    #ticketTable td:nth-of-type(1):before { content: "Ticket Name:"; }
    #ticketTable td:nth-of-type(2):before { content: "Price (£):"; }
    #ticketTable td:nth-of-type(3):before { content: "Expected %:"; }
    #ticketTable td:nth-of-type(4):before { content: "Actions:"; }
    
    #incomeTable td:nth-of-type(1):before { content: "Income Source:"; }
    #incomeTable td:nth-of-type(2):before { content: "Amount (£):"; }
    #incomeTable td:nth-of-type(3):before { content: "Notes:"; }
    #incomeTable td:nth-of-type(4):before { content: "Actions:"; }
    
    #expenseTable td:nth-of-type(1):before { content: "Category:"; }
    #expenseTable td:nth-of-type(2):before { content: "Expense Item:"; }
    #expenseTable td:nth-of-type(3):before { content: "Fixed Amount:"; }
    #expenseTable td:nth-of-type(4):before { content: "Per Person:"; }
    #expenseTable td:nth-of-type(5):before { content: "Notes:"; }
    #expenseTable td:nth-of-type(6):before { content: "Actions:"; }
    
    /* Exception for summary tables which should stay as is */
    .summary-table th, 
    .summary-table td,
    #ticketIncomeTable th,
    #ticketIncomeTable td,
    #expenseProjectionTable th,
    #expenseProjectionTable td {
        display: table-cell;
        padding: 5px;
        font-size: 0.8rem;
    }
    
    .summary-table,
    #ticketIncomeTable,
    #expenseProjectionTable {
        display: table;
        width: 100%;
        overflow-x: auto;
    }
    
    /* Make summary tables scrollable horizontally */
    .summary-table-wrapper,
    .income-projection-wrapper,
    .expense-projection-wrapper {
        width: 100%;
        overflow-x: auto;
    }
    
    /* Form controls adjustments */
    input, select, button {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 10px 8px; /* Larger touch targets */
    }
    
    /* Scenario controls in a more stacked layout */
    .ticket-scenarios {
        flex-direction: column;
    }
    
    .scenario-control {
        margin-bottom: 10px;
        width: 100%;
    }
    
    /* Action buttons adjustments */
    .action-buttons {
        flex-direction: column;
        gap: 5px;
    }
    
    .action-buttons button,
    .action-buttons select {
        width: 100%;
        margin-bottom: 5px;
    }
    
    /* Chart adjustments */
    .chart-container {
        height: 250px;
    }
}
    </style>
</head>
<body>
    <div class="container">
      <div class="header-container">
        <img src="https://www.angliastudent.com/stylesheet/Starlings/cambridge-union-logo-green.svg" alt="Logo" class="logo">
        <h1>Society Event Budgeting Planner</h1>
      </div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'setup')">Event Details</button>
            <button class="tab-button" onclick="openTab(event, 'tickets')">Ticket Types</button>
            <button class="tab-button" onclick="openTab(event, 'income')">Other Income</button>
            <button class="tab-button" onclick="openTab(event, 'expenses')">Expenses</button>
            <button class="tab-button" onclick="openTab(event, 'summary')">Summary</button>
        </div>
        
        <!-- Event Details Tab -->
        <div id="setup" class="tab-content" style="display: block;">
            <div class="card">
                <h2>Event Details</h2>
                <table>
                    <tr>
                        <td>Event Name:</td>
                        <td><input type="text" id="eventName" placeholder="Enter event name"></td>
                    </tr>
                    <tr>
                        <td>Event Date:</td>
                        <td><input type="date" id="eventDate"></td>
                    </tr>
                    <tr>
                        <td>Maximum Capacity:</td>
                        <td><input type="number" id="maxCapacity" placeholder="Enter maximum attendees" value="100"></td>
                    </tr>
                </table>
                
                <h3>Attendance Scenarios</h3>
                <div class="ticket-scenarios">
                    <div class="scenario-control">
                        <label for="scenario1">Scenario 1:</label>
                        <input type="number" id="scenario1" value="50" min="1" max="100"> %
                    </div>
                    <div class="scenario-control">
                        <label for="scenario2">Scenario 2:</label>
                        <input type="number" id="scenario2" value="70" min="1" max="100"> %
                    </div>
                    <div class="scenario-control">
                        <label for="scenario3">Scenario 3:</label>
                        <input type="number" id="scenario3" value="90" min="1" max="100"> %
                    </div>
                    <div class="scenario-control">
                        <label for="scenario4">Scenario 4:</label>
                        <input type="number" id="scenario4" value="100" min="1" max="100"> %
                    </div>
                </div>
                <button onclick="saveEventDetails()">Save Event Details</button>
            </div>
        <!--Save and load to local storage-->
            <div class="card">
                <h2>Save/Load Progress</h2>
                <p>You can save your progress and come back later to continue working on your budget.</p>
                <div class="action-buttons">
                    <button class="save-btn" onclick="saveToLocalStorage()">Save Progress</button>
                    <select id="savedBudgetsSelect" style="padding: 8px; margin-right: 10px;"></select>
                    <button class="load-btn" onclick="loadFromLocalStorage(document.getElementById('savedBudgetsSelect').value)">Load Saved Budget</button>
                    <button class="delete-btn" onclick="deleteSavedBudget(document.getElementById('savedBudgetsSelect').value)">Delete Saved Budget</button>
                    <button class="export-btn" onclick="exportToPDF()">Export as PDF</button>
                </div>
            </div>
        </div>
        
        <!-- Ticket Types Tab -->
        <div id="tickets" class="tab-content">
            <div class="card">
                <h2>Ticket Types</h2>
                <div style="margin-bottom: 15px;">
                    <label><input type="checkbox" id="pricesIncludeVAT" checked> Ticket prices include VAT (20%)</label>
                    <p style="margin-top: 5px; color: #666; font-size: 0.9em;">Note: A transaction fee of 20p will be automatically applied per ticket sold</p>
                </div>
                <table id="ticketTable">
                    <thead>
                        <tr>
                            <th>Ticket Name</th>
                            <th>Price (£)</th>
                            <th>Expected % of Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" placeholder="e.g. Early Bird" value="Standard Ticket"></td>
                            <td><input type="number" value="25.00" step="0.01" min="0"></td>
                            <td><input type="number" value="100" min="0" max="100"></td>
                            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                        </tr>
                    </tbody>
                </table>
                <button onclick="addTicketType()">Add Ticket Type</button>
                <button onclick="calculateTicketIncome()">Calculate Ticket Income</button>
            </div>
            
            <div class="card">
                <h2>Ticket Income Projections</h2>
                <div class="income-projection-wrapper">
                <table id="ticketIncomeTable">
                    <thead>
                        <tr>
                            <th>Ticket Type</th>
                            <th id="scenario1Header">Scenario 1 (50%)</th>
                            <th id="scenario2Header">Scenario 2 (70%)</th>
                            <th id="scenario3Header">Scenario 3 (90%)</th>
                            <th id="scenario4Header">Scenario 4 (100%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- This will be populated with JavaScript -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td>Net Ticket Income</td>
                            <td id="totalTicketScenario1">£0.00</td>
                            <td id="totalTicketScenario2">£0.00</td>
                            <td id="totalTicketScenario3">£0.00</td>
                            <td id="totalTicketScenario4">£0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        </div>
        
        <!-- Other Income Tab -->
        <div id="income" class="tab-content">
            <div class="card">
                <h2>Other Income Sources</h2>
                <table id="incomeTable">
                    <thead>
                        <tr>
                            <th>Income Source</th>
                            <th>Amount (£)</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" placeholder="e.g. Sponsorship" value="Sponsorship"></td>
                            <td><input type="number" value="500.00" step="0.01" min="0"></td>
                            <td><input type="text" placeholder="Additional details"></td>
                            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="1">Total Other Income</td>
                            <td id="totalOtherIncome">£500.00</td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
                <button onclick="addIncomeSource()">Add Income Source</button>
                <button onclick="calculateOtherIncome()">Calculate Other Income</button>
            </div>
        </div>
        
        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <div class="card">
                <h2>Expenses</h2>
                <table id="expenseTable">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Expense Item</th>
                            <th>Fixed Amount (£)</th>
                            <th>Per Person (£)</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select>
                                    <option>Venue</option>
                                    <option>Catering</option>
                                    <option>Marketing</option>
                                    <option>Entertainment</option>
                                    <option>Staffing</option>
                                    <option>Equipment</option>
                                    <option>Print & Design</option>
                                    <option>Transport</option>
                                    <option>Other</option>
                                </select>
                            </td>
                            <td><input type="text" placeholder="e.g. Venue Hire" value="Venue Hire"></td>
                            <td><input type="number" value="1000.00" step="0.01" min="0"></td>
                            <td><input type="number" value="0.00" step="0.01" min="0"></td>
                            <td><input type="text" placeholder="Additional details"></td>
                            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                        </tr>
                        <tr>
                            <td>
                                <select>
                                    <option>Venue</option>
                                    <option selected>Catering</option>
                                    <option>Marketing</option>
                                    <option>Entertainment</option>
                                    <option>Staffing</option>
                                    <option>Equipment</option>
                                    <option>Print & Design</option>
                                    <option>Transport</option>
                                    <option>Other</option>
                                </select>
                            </td>
                            <td><input type="text" placeholder="e.g. Food" value="Food"></td>
                            <td><input type="number" value="0.00" step="0.01" min="0"></td>
                            <td><input type="number" value="15.00" step="0.01" min="0"></td>
                            <td><input type="text" placeholder="Per person cost"></td>
                            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                        </tr>
                    </tbody>
                </table>
                <button onclick="addExpense()">Add Expense</button>
                <button onclick="calculateExpenses()">Calculate Expenses</button>
            </div>
            
            <div class="card">
                <h2>Expense Projections</h2>
                <div class="expense-projection-wrapper">
                <table id="expenseProjectionTable">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th id="expScenario1Header">Scenario 1 (50%)</th>
                            <th id="expScenario2Header">Scenario 2 (70%)</th>
                            <th id="expScenario3Header">Scenario 3 (90%)</th>
                            <th id="expScenario4Header">Scenario 4 (100%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- This will be populated with JavaScript -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td>Total Expenses</td>
                            <td id="totalExpenseScenario1">£0.00</td>
                            <td id="totalExpenseScenario2">£0.00</td>
                            <td id="totalExpenseScenario3">£0.00</td>
                            <td id="totalExpenseScenario4">£0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            </div>
        </div>
        
        <!-- Summary Tab -->
        <div id="summary" class="tab-content">
            <div class="card">
                <h2>Budget Summary</h2>
                <div class="summary-table-wrapper">
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th id="sumScenario1Header">Scenario 1 (50%)</th>
                            <th id="sumScenario2Header">Scenario 2 (70%)</th>
                            <th id="sumScenario3Header">Scenario 3 (90%)</th>
                            <th id="sumScenario4Header">Scenario 4 (100%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Gross Ticket Income</td>
                            <td id="summaryGrossTicketScenario1">£0.00</td>
                            <td id="summaryGrossTicketScenario2">£0.00</td>
                            <td id="summaryGrossTicketScenario3">£0.00</td>
                            <td id="summaryGrossTicketScenario4">£0.00</td>
                        </tr>
                        <tr>
                            <td>Less Transaction Fees (20p/ticket)</td>
                            <td id="summaryTransactionFeesScenario1">£0.00</td>
                            <td id="summaryTransactionFeesScenario2">£0.00</td>
                            <td id="summaryTransactionFeesScenario3">£0.00</td>
                            <td id="summaryTransactionFeesScenario4">£0.00</td>
                        </tr>
                        <tr>
                            <td>Less VAT (20%)</td>
                            <td id="summaryVATScenario1">£0.00</td>
                            <td id="summaryVATScenario2">£0.00</td>
                            <td id="summaryVATScenario3">£0.00</td>
                            <td id="summaryVATScenario4">£0.00</td>
                        </tr>
                        <tr>
                            <td>Net Ticket Income</td>
                            <td id="summaryTicketScenario1">£0.00</td>
                            <td id="summaryTicketScenario2">£0.00</td>
                            <td id="summaryTicketScenario3">£0.00</td>
                            <td id="summaryTicketScenario4">£0.00</td>
                        </tr>
                        <tr>
                            <td>Other Income</td>
                            <td id="summaryOtherIncome">£0.00</td>
                            <td id="summaryOtherIncome2">£0.00</td>
                            <td id="summaryOtherIncome3">£0.00</td>
                            <td id="summaryOtherIncome4">£0.00</td>
                        </tr>
                        <tr class="total-row">
                            <td>Total Income</td>
                            <td id="summaryTotalIncomeScenario1">£0.00</td>
                            <td id="summaryTotalIncomeScenario2">£0.00</td>
                            <td id="summaryTotalIncomeScenario3">£0.00</td>
                            <td id="summaryTotalIncomeScenario4">£0.00</td>
                        </tr>
                        <tr>
                            <td>Total Expenses</td>
                            <td id="summaryExpenseScenario1">£0.00</td>
                            <td id="summaryExpenseScenario2">£0.00</td>
                            <td id="summaryExpenseScenario3">£0.00</td>
                            <td id="summaryExpenseScenario4">£0.00</td>
                        </tr>
                        <tr class="total-row">
                            <td>Net Profit/Loss</td>
                            <td id="summaryProfitScenario1">£0.00</td>
                            <td id="summaryProfitScenario2">£0.00</td>
                            <td id="summaryProfitScenario3">£0.00</td>
                            <td id="summaryProfitScenario4">£0.00</td>
                        </tr>
                    </tbody>
                </table>
            </div>
                
                <h3>Break-Even Analysis</h3>
                <div id="breakEvenAnalysis">
                    <p>Based on your fixed costs and per-person variable costs:</p>
                    <p id="breakEvenPoint">You need to sell <strong>0</strong> tickets to break even.</p>
                    <p id="breakEvenRevenue">This represents <strong>£0.00</strong> in revenue.</p>
                </div>
                
                <div class="action-buttons">
                    <button onclick="printSummary()">Print Summary</button>
                    <button onclick="exportToCSV()">Export to CSV</button>
                    <button class="export-btn" onclick="exportToPDF()">Export as PDF</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script>
        // Tab functionality
        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            
            // Hide all tab content
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            // Remove the "active" class from all tab buttons
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }
            
            // Show the current tab and add an "active" class to the button that opened the tab
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            
            // If summary tab is opened, update all calculations
            if (tabName === "summary") {
                calculateTicketIncome();
                calculateOtherIncome();
                calculateExpenses();
                updateSummary();
                updateChart();
            }
        }
        
        // Event details functions
        function saveEventDetails() {
            // Get scenario percentages and update headers
            const scenario1 = document.getElementById("scenario1").value;
            const scenario2 = document.getElementById("scenario2").value;
            const scenario3 = document.getElementById("scenario3").value;
            const scenario4 = document.getElementById("scenario4").value;
            
            // Update all scenario headers
            document.getElementById("scenario1Header").textContent = `Scenario 1 (${scenario1}%)`;
            document.getElementById("scenario2Header").textContent = `Scenario 2 (${scenario2}%)`;
            document.getElementById("scenario3Header").textContent = `Scenario 3 (${scenario3}%)`;
            document.getElementById("scenario4Header").textContent = `Scenario 4 (${scenario4}%)`;
            
            document.getElementById("expScenario1Header").textContent = `Scenario 1 (${scenario1}%)`;
            document.getElementById("expScenario2Header").textContent = `Scenario 2 (${scenario2}%)`;
            document.getElementById("expScenario3Header").textContent = `Scenario 3 (${scenario3}%)`;
            document.getElementById("expScenario4Header").textContent = `Scenario 4 (${scenario4}%)`;
            
            document.getElementById("sumScenario1Header").textContent = `Scenario 1 (${scenario1}%)`;
            document.getElementById("sumScenario2Header").textContent = `Scenario 2 (${scenario2}%)`;
            document.getElementById("sumScenario3Header").textContent = `Scenario 3 (${scenario3}%)`;
            document.getElementById("sumScenario4Header").textContent = `Scenario 4 (${scenario4}%)`;
            
            showNotification("Event details saved successfully!");
        }
        
        // Ticket functions
        function addTicketType() {
            const ticketTable = document.getElementById("ticketTable").getElementsByTagName('tbody')[0];
            const newRow = ticketTable.insertRow();
            
            newRow.innerHTML = `
                <td><input type="text" placeholder="e.g. VIP Ticket"></td>
                <td><input type="number" value="0.00" step="0.01" min="0"></td>
                <td><input type="number" value="0" min="0" max="100"></td>
                <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
            `;
        }
        
        function calculateTicketIncome() {
            const ticketTable = document.getElementById("ticketTable").getElementsByTagName('tbody')[0];
            const ticketIncomeTable = document.getElementById("ticketIncomeTable").getElementsByTagName('tbody')[0];
            const maxCapacity = parseFloat(document.getElementById("maxCapacity").value) || 100;
            const pricesIncludeVAT = document.getElementById("pricesIncludeVAT").checked;
            const VAT_RATE = 0.20; // 20% VAT
            const TRANSACTION_FEE = 0.20; // 20p per ticket
            
            // Get scenario percentages
            const scenario1 = parseFloat(document.getElementById("scenario1").value) / 100 || 0.5;
            const scenario2 = parseFloat(document.getElementById("scenario2").value) / 100 || 0.7;
            const scenario3 = parseFloat(document.getElementById("scenario3").value) / 100 || 0.9;
            const scenario4 = parseFloat(document.getElementById("scenario4").value) / 100 || 1.0;
            
            // Clear previous calculations
            ticketIncomeTable.innerHTML = "";
            
            let grossScenario1 = 0;
            let grossScenario2 = 0;
            let grossScenario3 = 0;
            let grossScenario4 = 0;
            
            let totalTicketsScenario1 = 0;
            let totalTicketsScenario2 = 0;
            let totalTicketsScenario3 = 0;
            let totalTicketsScenario4 = 0;
            
            // Calculate for each ticket type
            for (let i = 0; i < ticketTable.rows.length; i++) {
                const row = ticketTable.rows[i];
                const ticketName = row.cells[0].getElementsByTagName('input')[0].value;
                const ticketPrice = parseFloat(row.cells[1].getElementsByTagName('input')[0].value) || 0;
                const ticketPercentage = parseFloat(row.cells[2].getElementsByTagName('input')[0].value) / 100 || 0;
                
                // Calculate number of tickets for each scenario
                const maxTickets = maxCapacity * ticketPercentage;
                const scenario1Tickets = Math.floor(maxTickets * scenario1);
                const scenario2Tickets = Math.floor(maxTickets * scenario2);
                const scenario3Tickets = Math.floor(maxTickets * scenario3);
                const scenario4Tickets = Math.floor(maxTickets * scenario4);
                
                // Track total tickets
                totalTicketsScenario1 += scenario1Tickets;
                totalTicketsScenario2 += scenario2Tickets;
                totalTicketsScenario3 += scenario3Tickets;
                totalTicketsScenario4 += scenario4Tickets;
                
                // Calculate gross income
                const scenario1Income = scenario1Tickets * ticketPrice;
                const scenario2Income = scenario2Tickets * ticketPrice;
                const scenario3Income = scenario3Tickets * ticketPrice;
                const scenario4Income = scenario4Tickets * ticketPrice;
                
                // Add to gross totals
                grossScenario1 += scenario1Income;
                grossScenario2 += scenario2Income;
                grossScenario3 += scenario3Income;
                grossScenario4 += scenario4Income;
                
                // Create a new row in the ticket income table
                const newRow = ticketIncomeTable.insertRow();
                newRow.innerHTML = `
                    <td>${ticketName} (${ticketPercentage * 100}% of attendees)</td>
                    <td>£${scenario1Income.toFixed(2)} (${scenario1Tickets} tickets)</td>
                    <td>£${scenario2Income.toFixed(2)} (${scenario2Tickets} tickets)</td>
                    <td>£${scenario3Income.toFixed(2)} (${scenario3Tickets} tickets)</td>
                    <td>£${scenario4Income.toFixed(2)} (${scenario4Tickets} tickets)</td>
                `;
            }
            
            // Calculate transaction fees first
const transactionFeeScenario1 = totalTicketsScenario1 * TRANSACTION_FEE;
const transactionFeeScenario2 = totalTicketsScenario2 * TRANSACTION_FEE;
const transactionFeeScenario3 = totalTicketsScenario3 * TRANSACTION_FEE;
const transactionFeeScenario4 = totalTicketsScenario4 * TRANSACTION_FEE;

// Deduct transaction fees from gross
const afterTransactionFee1 = grossScenario1 - transactionFeeScenario1;
const afterTransactionFee2 = grossScenario2 - transactionFeeScenario2;
const afterTransactionFee3 = grossScenario3 - transactionFeeScenario3;
const afterTransactionFee4 = grossScenario4 - transactionFeeScenario4;

// Calculate VAT on remaining amount
let vatScenario1, vatScenario2, vatScenario3, vatScenario4;

if (pricesIncludeVAT) {
    // If prices include VAT, calculate the VAT portion
    vatScenario1 = afterTransactionFee1 * VAT_RATE / (1 + VAT_RATE);
    vatScenario2 = afterTransactionFee2 * VAT_RATE / (1 + VAT_RATE);
    vatScenario3 = afterTransactionFee3 * VAT_RATE / (1 + VAT_RATE);
    vatScenario4 = afterTransactionFee4 * VAT_RATE / (1 + VAT_RATE);
} else {
    // If prices exclude VAT, add it on top
    vatScenario1 = afterTransactionFee1 * VAT_RATE;
    vatScenario2 = afterTransactionFee2 * VAT_RATE;
    vatScenario3 = afterTransactionFee3 * VAT_RATE;
    vatScenario4 = afterTransactionFee4 * VAT_RATE;
}

// Calculate net ticket income (after transaction fees and VAT)
const netScenario1 = afterTransactionFee1 - vatScenario1;
const netScenario2 = afterTransactionFee2 - vatScenario2;
const netScenario3 = afterTransactionFee3 - vatScenario3;
const netScenario4 = afterTransactionFee4 - vatScenario4;
            
            // Add VAT and transaction fee rows to the ticket income table
const transactionRow = ticketIncomeTable.insertRow();
transactionRow.innerHTML = `
    <td><strong>Less Transaction Fees (20p/ticket)</strong></td>
    <td>-£${transactionFeeScenario1.toFixed(2)} (${totalTicketsScenario1} tickets)</td>
    <td>-£${transactionFeeScenario2.toFixed(2)} (${totalTicketsScenario2} tickets)</td>
    <td>-£${transactionFeeScenario3.toFixed(2)} (${totalTicketsScenario3} tickets)</td>
    <td>-£${transactionFeeScenario4.toFixed(2)} (${totalTicketsScenario4} tickets)</td>
`;

const vatRow = ticketIncomeTable.insertRow();
vatRow.innerHTML = `
    <td><strong>Less VAT (20%)</strong></td>
    <td>-£${vatScenario1.toFixed(2)}</td>
    <td>-£${vatScenario2.toFixed(2)}</td>
    <td>-£${vatScenario3.toFixed(2)}</td>
    <td>-£${vatScenario4.toFixed(2)}</td>
`;
            
            // Update totals in the ticket income table
            document.getElementById("totalTicketScenario1").textContent = `£${netScenario1.toFixed(2)}`;
            document.getElementById("totalTicketScenario2").textContent = `£${netScenario2.toFixed(2)}`;
            document.getElementById("totalTicketScenario3").textContent = `£${netScenario3.toFixed(2)}`;
            document.getElementById("totalTicketScenario4").textContent = `£${netScenario4.toFixed(2)}`;
            
            // Update summary values
            document.getElementById("summaryGrossTicketScenario1").textContent = `£${grossScenario1.toFixed(2)}`;
            document.getElementById("summaryGrossTicketScenario2").textContent = `£${grossScenario2.toFixed(2)}`;
            document.getElementById("summaryGrossTicketScenario3").textContent = `£${grossScenario3.toFixed(2)}`;
            document.getElementById("summaryGrossTicketScenario4").textContent = `£${grossScenario4.toFixed(2)}`;
            
            document.getElementById("summaryVATScenario1").textContent = `£${vatScenario1.toFixed(2)}`;
            document.getElementById("summaryVATScenario2").textContent = `£${vatScenario2.toFixed(2)}`;
            document.getElementById("summaryVATScenario3").textContent = `£${vatScenario3.toFixed(2)}`;
            document.getElementById("summaryVATScenario4").textContent = `£${vatScenario4.toFixed(2)}`;
            
            document.getElementById("summaryTransactionFeesScenario1").textContent = `£${transactionFeeScenario1.toFixed(2)}`;
            document.getElementById("summaryTransactionFeesScenario2").textContent = `£${transactionFeeScenario2.toFixed(2)}`;
            document.getElementById("summaryTransactionFeesScenario3").textContent = `£${transactionFeeScenario3.toFixed(2)}`;
            document.getElementById("summaryTransactionFeesScenario4").textContent = `£${transactionFeeScenario4.toFixed(2)}`;
            
            document.getElementById("summaryTicketScenario1").textContent = `£${netScenario1.toFixed(2)}`;
            document.getElementById("summaryTicketScenario2").textContent = `£${netScenario2.toFixed(2)}`;
            document.getElementById("summaryTicketScenario3").textContent = `£${netScenario3.toFixed(2)}`;
            document.getElementById("summaryTicketScenario4").textContent = `£${netScenario4.toFixed(2)}`;
            
            updateSummary();
        }
        
        // Income functions
        function addIncomeSource() {
            const incomeTable = document.getElementById("incomeTable").getElementsByTagName('tbody')[0];
            const newRow = incomeTable.insertRow();
            
            newRow.innerHTML = `
                <td><input type="text" placeholder="e.g. Merchandise"></td>
                <td><input type="number" value="0.00" step="0.01" min="0"></td>
                <td><input type="text" placeholder="Additional details"></td>
                <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
            `;
        }
        
        function calculateOtherIncome() {
            const incomeTable = document.getElementById("incomeTable").getElementsByTagName('tbody')[0];
            let totalIncome = 0;
            
            // Calculate total income
            for (let i = 0; i < incomeTable.rows.length; i++) {
                const row = incomeTable.rows[i];
                const incomeAmount = parseFloat(row.cells[1].getElementsByTagName('input')[0].value) || 0;
                totalIncome += incomeAmount;
            }
            
            // Update total
            document.getElementById("totalOtherIncome").textContent = `£${totalIncome.toFixed(2)}`;
            
            // Update summary values (other income is fixed across all scenarios)
            document.getElementById("summaryOtherIncome").textContent = `£${totalIncome.toFixed(2)}`;
            document.getElementById("summaryOtherIncome2").textContent = `£${totalIncome.toFixed(2)}`;
            document.getElementById("summaryOtherIncome3").textContent = `£${totalIncome.toFixed(2)}`;
            document.getElementById("summaryOtherIncome4").textContent = `£${totalIncome.toFixed(2)}`;
            
            updateSummary();
        }
        
        // Expense functions
        function addExpense() {
            const expenseTable = document.getElementById("expenseTable").getElementsByTagName('tbody')[0];
            const newRow = expenseTable.insertRow();
            
            newRow.innerHTML = `
                <td>
                    <select>
                        <option>Venue</option>
                        <option>Catering</option>
                        <option>Marketing</option>
                        <option>Entertainment</option>
                        <option>Staffing</option>
                        <option>Equipment</option>
                        <option>Print & Design</option>
                        <option>Transport</option>
                        <option>Other</option>
                    </select>
                </td>
                <td><input type="text" placeholder="e.g. Security"></td>
                <td><input type="number" value="0.00" step="0.01" min="0"></td>
                <td><input type="number" value="0.00" step="0.01" min="0"></td>
                <td><input type="text" placeholder="Additional details"></td>
                <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
            `;
        }
        
        function calculateExpenses() {
            const expenseTable = document.getElementById("expenseTable").getElementsByTagName('tbody')[0];
            const expenseProjectionTable = document.getElementById("expenseProjectionTable").getElementsByTagName('tbody')[0];
            const maxCapacity = parseFloat(document.getElementById("maxCapacity").value) || 100;
            
            // Get scenario percentages
            const scenario1 = parseFloat(document.getElementById("scenario1").value) / 100 || 0.5;
            const scenario2 = parseFloat(document.getElementById("scenario2").value) / 100 || 0.7;
            const scenario3 = parseFloat(document.getElementById("scenario3").value) / 100 || 0.9;
            const scenario4 = parseFloat(document.getElementById("scenario4").value) / 100 || 1.0;
            
            // Clear previous calculations
            expenseProjectionTable.innerHTML = "";
            
            // Create an object to group expenses by category
            const categorizedExpenses = {};
            
            // Process each expense
            for (let i = 0; i < expenseTable.rows.length; i++) {
                const row = expenseTable.rows[i];
                const category = row.cells[0].getElementsByTagName('select')[0].value;
                const itemName = row.cells[1].getElementsByTagName('input')[0].value;
                const fixedAmount = parseFloat(row.cells[2].getElementsByTagName('input')[0].value) || 0;
                const perPersonAmount = parseFloat(row.cells[3].getElementsByTagName('input')[0].value) || 0;
                
                // Initialize category if it doesn't exist
                if (!categorizedExpenses[category]) {
                    categorizedExpenses[category] = {
                        fixedTotal: 0,
                        perPersonTotal: 0,
                        items: []
                    };
                }
                
                // Add expense to category
                categorizedExpenses[category].fixedTotal += fixedAmount;
                categorizedExpenses[category].perPersonTotal += perPersonAmount;
                categorizedExpenses[category].items.push({
                    name: itemName,
                    fixed: fixedAmount,
                    perPerson: perPersonAmount
                });
            }
            
            // Calculate expense projections for each category
            let totalScenario1 = 0;
            let totalScenario2 = 0;
            let totalScenario3 = 0;
            let totalScenario4 = 0;
            
            for (const category in categorizedExpenses) {
                const expenseData = categorizedExpenses[category];
                
                // Calculate attendance for each scenario
                const scenario1Attendance = Math.floor(maxCapacity * scenario1);
                const scenario2Attendance = Math.floor(maxCapacity * scenario2);
                const scenario3Attendance = Math.floor(maxCapacity * scenario3);
                const scenario4Attendance = Math.floor(maxCapacity * scenario4);
                
                // Calculate total expenses for each scenario
                const scenario1Expense = expenseData.fixedTotal + (expenseData.perPersonTotal * scenario1Attendance);
                const scenario2Expense = expenseData.fixedTotal + (expenseData.perPersonTotal * scenario2Attendance);
                const scenario3Expense = expenseData.fixedTotal + (expenseData.perPersonTotal * scenario3Attendance);
                const scenario4Expense = expenseData.fixedTotal + (expenseData.perPersonTotal * scenario4Attendance);
                
                // Add to totals
                totalScenario1 += scenario1Expense;
                totalScenario2 += scenario2Expense;
                totalScenario3 += scenario3Expense;
                totalScenario4 += scenario4Expense;
                
                // Create a new row in the expense projection table
                const newRow = expenseProjectionTable.insertRow();
                newRow.innerHTML = `
                    <td>${category}</td>
                    <td>£${scenario1Expense.toFixed(2)}</td>
                    <td>£${scenario2Expense.toFixed(2)}</td>
                    <td>£${scenario3Expense.toFixed(2)}</td>
                    <td>£${scenario4Expense.toFixed(2)}</td>
                `;
            }
            
            // Update totals
            document.getElementById("totalExpenseScenario1").textContent = `£${totalScenario1.toFixed(2)}`;
            document.getElementById("totalExpenseScenario2").textContent = `£${totalScenario2.toFixed(2)}`;
            document.getElementById("totalExpenseScenario3").textContent = `£${totalScenario3.toFixed(2)}`;
            document.getElementById("totalExpenseScenario4").textContent = `£${totalScenario4.toFixed(2)}`;
            
            // Update summary values
            document.getElementById("summaryExpenseScenario1").textContent = `£${totalScenario1.toFixed(2)}`;
            document.getElementById("summaryExpenseScenario2").textContent = `£${totalScenario2.toFixed(2)}`;
            document.getElementById("summaryExpenseScenario3").textContent = `£${totalScenario3.toFixed(2)}`;
            document.getElementById("summaryExpenseScenario4").textContent = `£${totalScenario4.toFixed(2)}`;
            
            // Calculate and update break-even point
            calculateBreakEven();
            updateSummary();
        }
        
        function calculateBreakEven() {
    const expenseTable = document.getElementById("expenseTable").getElementsByTagName('tbody')[0];
    const ticketTable = document.getElementById("ticketTable").getElementsByTagName('tbody')[0];
    const otherIncomeTable = document.getElementById("incomeTable").getElementsByTagName('tbody')[0];
    
    // Calculate fixed and variable costs
    let fixedCosts = 0;
    let variableCostPerPerson = 0;
    
    // Get all fixed costs from expenses
    for (let i = 0; i < expenseTable.rows.length; i++) {
        const row = expenseTable.rows[i];
        const rowFixedCost = parseFloat(row.cells[2].getElementsByTagName('input')[0].value) || 0;
        const rowVarCost = parseFloat(row.cells[3].getElementsByTagName('input')[0].value) || 0;
        
        fixedCosts += rowFixedCost;
        variableCostPerPerson += rowVarCost;
    }
    
    // Calculate total other income
    let otherIncome = 0;
    for (let i = 0; i < otherIncomeTable.rows.length; i++) {
        const row = otherIncomeTable.rows[i];
        const incomeAmount = parseFloat(row.cells[1].getElementsByTagName('input')[0].value) || 0;
        otherIncome += incomeAmount;
    }
    
    // Reduce fixed costs by other income (as it's already covering some fixed costs)
    const fixedCostsAfterOtherIncome = Math.max(0, fixedCosts - otherIncome);
    
    // Calculate average ticket price and revenue per ticket
    let totalTicketPrice = 0;
    let totalTicketPercentage = 0;
    
    for (let i = 0; i < ticketTable.rows.length; i++) {
        const row = ticketTable.rows[i];
        const ticketPrice = parseFloat(row.cells[1].getElementsByTagName('input')[0].value) || 0;
        const ticketPercentage = parseFloat(row.cells[2].getElementsByTagName('input')[0].value) / 100 || 0;
        
        totalTicketPrice += ticketPrice * ticketPercentage;
        totalTicketPercentage += ticketPercentage;
    }
    
    const avgTicketPrice = totalTicketPercentage > 0 ? totalTicketPrice / totalTicketPercentage : 0;
    
    // Account for transaction fees and VAT
    const pricesIncludeVAT = document.getElementById("pricesIncludeVAT").checked;
    const VAT_RATE = 0.20; // 20% VAT
    const TRANSACTION_FEE = 0.20; // 20p per ticket
    
    // Calculate net revenue per ticket after transaction fee and VAT
    let netPerTicket = avgTicketPrice - TRANSACTION_FEE;
    
    if (pricesIncludeVAT) {
        const vatAmount = netPerTicket * VAT_RATE / (1 + VAT_RATE);
        netPerTicket = netPerTicket - vatAmount;
    }
    
    // Calculate contribution margin
    const contributionMargin = netPerTicket - variableCostPerPerson;
    
    // Calculate and display break-even point
    let breakEvenTickets = 0;
    let breakEvenRevenue = 0;
    let breakEvenMessage = "";
    
    // If other income already covers all fixed costs
    if (fixedCostsAfterOtherIncome <= 0) {
        breakEvenMessage = "Your other income of <strong>£" + otherIncome.toFixed(2) + "</strong> already covers your fixed costs of <strong>£" + fixedCosts.toFixed(2) + "</strong>.";
        breakEvenTickets = 0;
        breakEvenRevenue = 0;
    }
    // If contribution margin is zero or negative
    else if (contributionMargin <= 0) {
        breakEvenMessage = "Your ticket sales can't cover costs because your variable cost per person (<strong>£" + variableCostPerPerson.toFixed(2) + "</strong>) exceeds your net per-ticket revenue (<strong>£" + netPerTicket.toFixed(2) + "</strong>).";
        breakEvenTickets = Infinity;
        breakEvenRevenue = Infinity;
    }
    // Normal break-even calculation
    else {
        breakEvenTickets = Math.ceil(fixedCostsAfterOtherIncome / contributionMargin);
        breakEvenRevenue = breakEvenTickets * avgTicketPrice;
        breakEvenMessage = "You need to sell <strong>" + breakEvenTickets + "</strong> tickets to break even.";
    }
    
    // Update break-even analysis display
    document.getElementById("breakEvenPoint").innerHTML = breakEvenMessage;
    
    // Only show revenue message if we have a valid number
    if (breakEvenTickets > 0 && breakEvenTickets < Infinity) {
        document.getElementById("breakEvenRevenue").innerHTML = "This represents <strong>£" + breakEvenRevenue.toFixed(2) + "</strong> in revenue.";
    } else if (breakEvenTickets === 0) {
        document.getElementById("breakEvenRevenue").innerHTML = "You don't need to sell any tickets to break even.";
    } else {
        document.getElementById("breakEvenRevenue").innerHTML = "Break-even is not possible with current pricing and costs.";
    }
    
    // Check against venue capacity
    const maxCapacity = parseFloat(document.getElementById("maxCapacity").value) || 100;
    if (breakEvenTickets > maxCapacity && breakEvenTickets < Infinity) {
        document.getElementById("breakEvenPoint").innerHTML += " <span style='color: red;'>(Exceeds venue capacity of " + maxCapacity + ")</span>";
    }
}
        
        // Summary functions
        function updateSummary() {
            // Get ticket income
            const ticketScenario1 = parseFloat(document.getElementById("summaryTicketScenario1").textContent.replace('£', '')) || 0;
            const ticketScenario2 = parseFloat(document.getElementById("summaryTicketScenario2").textContent.replace('£', '')) || 0;
            const ticketScenario3 = parseFloat(document.getElementById("summaryTicketScenario3").textContent.replace('£', '')) || 0;
            const ticketScenario4 = parseFloat(document.getElementById("summaryTicketScenario4").textContent.replace('£', '')) || 0;
            
            // Get other income
            const otherIncome = parseFloat(document.getElementById("summaryOtherIncome").textContent.replace('£', '')) || 0;
            
            // Get expenses
            const expenseScenario1 = parseFloat(document.getElementById("summaryExpenseScenario1").textContent.replace('£', '')) || 0;
            const expenseScenario2 = parseFloat(document.getElementById("summaryExpenseScenario2").textContent.replace('£', '')) || 0;
            const expenseScenario3 = parseFloat(document.getElementById("summaryExpenseScenario3").textContent.replace('£', '')) || 0;
            const expenseScenario4 = parseFloat(document.getElementById("summaryExpenseScenario4").textContent.replace('£', '')) || 0;
            
            // Calculate total income
            const totalIncomeScenario1 = ticketScenario1 + otherIncome;
            const totalIncomeScenario2 = ticketScenario2 + otherIncome;
            const totalIncomeScenario3 = ticketScenario3 + otherIncome;
            const totalIncomeScenario4 = ticketScenario4 + otherIncome;
            
            // Calculate profit/loss
            const profitScenario1 = totalIncomeScenario1 - expenseScenario1;
            const profitScenario2 = totalIncomeScenario2 - expenseScenario2;
            const profitScenario3 = totalIncomeScenario3 - expenseScenario3;
            const profitScenario4 = totalIncomeScenario4 - expenseScenario4;
            
            // Update summary totals
            document.getElementById("summaryTotalIncomeScenario1").textContent = `£${totalIncomeScenario1.toFixed(2)}`;
            document.getElementById("summaryTotalIncomeScenario2").textContent = `£${totalIncomeScenario2.toFixed(2)}`;
            document.getElementById("summaryTotalIncomeScenario3").textContent = `£${totalIncomeScenario3.toFixed(2)}`;
            document.getElementById("summaryTotalIncomeScenario4").textContent = `£${totalIncomeScenario4.toFixed(2)}`;
            
            // Update profit/loss with colors
            const profitElement1 = document.getElementById("summaryProfitScenario1");
            profitElement1.textContent = `£${profitScenario1.toFixed(2)}`;
            profitElement1.className = profitScenario1 >= 0 ? "positive" : "negative";
            
            const profitElement2 = document.getElementById("summaryProfitScenario2");
            profitElement2.textContent = `£${profitScenario2.toFixed(2)}`;
            profitElement2.className = profitScenario2 >= 0 ? "positive" : "negative";
            
            const profitElement3 = document.getElementById("summaryProfitScenario3");
            profitElement3.textContent = `£${profitScenario3.toFixed(2)}`;
            profitElement3.className = profitScenario3 >= 0 ? "positive" : "negative";
            
            const profitElement4 = document.getElementById("summaryProfitScenario4");
            profitElement4.textContent = `£${profitScenario4.toFixed(2)}`;
            profitElement4.className = profitScenario4 >= 0 ? "positive" : "negative";
        }
        
        function updateChart() {
            const ctx = document.getElementById('summaryChart').getContext('2d');
            
            // Get scenario percentages
            const scenario1 = document.getElementById("scenario1").value;
            const scenario2 = document.getElementById("scenario2").value;
            const scenario3 = document.getElementById("scenario3").value;
            const scenario4 = document.getElementById("scenario4").value;
            
            // Get profit/loss values
            const profitScenario1 = parseFloat(document.getElementById("summaryProfitScenario1").textContent.replace('£', '')) || 0;
            const profitScenario2 = parseFloat(document.getElementById("summaryProfitScenario2").textContent.replace('£', '')) || 0;
            const profitScenario3 = parseFloat(document.getElementById("summaryProfitScenario3").textContent.replace('£', '')) || 0;
            const profitScenario4 = parseFloat(document.getElementById("summaryProfitScenario4").textContent.replace('£', '')) || 0;
            
            // Get income values
            const incomeScenario1 = parseFloat(document.getElementById("summaryTotalIncomeScenario1").textContent.replace('£', '')) || 0;
            const incomeScenario2 = parseFloat(document.getElementById("summaryTotalIncomeScenario2").textContent.replace('£', '')) || 0;
            const incomeScenario3 = parseFloat(document.getElementById("summaryTotalIncomeScenario3").textContent.replace('£', '')) || 0;
            const incomeScenario4 = parseFloat(document.getElementById("summaryTotalIncomeScenario4").textContent.replace('£', '')) || 0;
            
            // Get expense values
            const expenseScenario1 = parseFloat(document.getElementById("summaryExpenseScenario1").textContent.replace('£', '')) || 0;
            const expenseScenario2 = parseFloat(document.getElementById("summaryExpenseScenario2").textContent.replace('£', '')) || 0;
            const expenseScenario3 = parseFloat(document.getElementById("summaryExpenseScenario3").textContent.replace('£', '')) || 0;
            const expenseScenario4 = parseFloat(document.getElementById("summaryExpenseScenario4").textContent.replace('£', '')) || 0;
            
            // Create the chart
            if (window.summaryChart) {
                window.summaryChart.destroy();
            }
            
            window.summaryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [`${scenario1}% Attendance`, `${scenario2}% Attendance`, `${scenario3}% Attendance`, `${scenario4}% Attendance`],
                    datasets: [
                        {
                            label: 'Total Income',
                            data: [incomeScenario1, incomeScenario2, incomeScenario3, incomeScenario4],
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Total Expenses',
                            data: [expenseScenario1, expenseScenario2, expenseScenario3, expenseScenario4],
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Net Profit/Loss',
                            data: [profitScenario1, profitScenario2, profitScenario3, profitScenario4],
                            backgroundColor: function(context) {
                                const value = context.dataset.data[context.dataIndex];
                                return value >= 0 ? 'rgba(75, 192, 192, 0.5)' : 'rgba(255, 159, 64, 0.5)';
                            },
                            borderColor: function(context) {
                                const value = context.dataset.data[context.dataIndex];
                                return value >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 159, 64, 1)';
                            },
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (£)'
                            }
                        }
                    }
                }
            });
        }
        
        // Utility functions
        function deleteRow(button) {
            const row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }
        
        function printSummary() {
            window.print();
        }
        
        function exportToCSV() {
            // Get event name
            const eventName = document.getElementById("eventName").value || "Event";
            
            // Prepare CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Event Budget Summary: " + eventName + "\n\n";
            
            // Get scenario percentages
            const scenario1 = document.getElementById("scenario1").value;
            const scenario2 = document.getElementById("scenario2").value;
            const scenario3 = document.getElementById("scenario3").value;
            const scenario4 = document.getElementById("scenario4").value;
            
            // Add summary data
            csvContent += "Category,Scenario 1 (" + scenario1 + "%),Scenario 2 (" + scenario2 + "%),Scenario 3 (" + scenario3 + "%),Scenario 4 (" + scenario4 + "%)\n";
            
            csvContent += "Total Ticket Income," + 
                document.getElementById("summaryTicketScenario1").textContent + "," +
                document.getElementById("summaryTicketScenario2").textContent + "," +
                document.getElementById("summaryTicketScenario3").textContent + "," +
                document.getElementById("summaryTicketScenario4").textContent + "\n";
                
            csvContent += "Other Income," + 
                document.getElementById("summaryOtherIncome").textContent + "," +
                document.getElementById("summaryOtherIncome2").textContent + "," +
                document.getElementById("summaryOtherIncome3").textContent + "," +
                document.getElementById("summaryOtherIncome4").textContent + "\n";
                
            csvContent += "Total Income," + 
                document.getElementById("summaryTotalIncomeScenario1").textContent + "," +
                document.getElementById("summaryTotalIncomeScenario2").textContent + "," +
                document.getElementById("summaryTotalIncomeScenario3").textContent + "," +
                document.getElementById("summaryTotalIncomeScenario4").textContent + "\n";
                
            csvContent += "Total Expenses," + 
                document.getElementById("summaryExpenseScenario1").textContent + "," +
                document.getElementById("summaryExpenseScenario2").textContent + "," +
                document.getElementById("summaryExpenseScenario3").textContent + "," +
                document.getElementById("summaryExpenseScenario4").textContent + "\n";
                
            csvContent += "Net Profit/Loss," + 
                document.getElementById("summaryProfitScenario1").textContent + "," +
                document.getElementById("summaryProfitScenario2").textContent + "," +
                document.getElementById("summaryProfitScenario3").textContent + "," +
                document.getElementById("summaryProfitScenario4").textContent + "\n";
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", eventName + "_Budget_Summary.csv");
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
        }
        
        // New functions for cookie-based save/load and PDF export
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            // Hide the notification after 3 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const eventName = document.getElementById("eventName").value || "Event Budget";
    
    try {
        // Create a new PDF document
        const doc = new jsPDF();
        let currentY = 22;
        
        // Add title
        doc.setFontSize(18);
        doc.text(eventName + " - Budget Report", 14, currentY);
        currentY += 10;
        
        // Add event details
        doc.setFontSize(12);
        doc.text("Event Date: " + document.getElementById("eventDate").value, 14, currentY);
        currentY += 6;
        doc.text("Maximum Capacity: " + document.getElementById("maxCapacity").value, 14, currentY);
        currentY += 12;
        
        // Add ticket type details
        doc.setFontSize(14);
        doc.text("Ticket Types", 14, currentY);
        currentY += 8;
        
        const ticketTable = document.getElementById("ticketTable").getElementsByTagName('tbody')[0];
        
        // Create ticket types table data
        const ticketHeaders = [["Ticket Name", "Price (£)", "Expected % of Total"]];
        const ticketData = [];
        
        for (let i = 0; i < ticketTable.rows.length; i++) {
            const row = ticketTable.rows[i];
            ticketData.push([
                row.cells[0].getElementsByTagName('input')[0].value,
                row.cells[1].getElementsByTagName('input')[0].value,
                row.cells[2].getElementsByTagName('input')[0].value + "%"
            ]);
        }
        
        // Generate ticket types table
        doc.autoTable({
            startY: currentY,
            head: ticketHeaders,
            body: ticketData,
            theme: 'grid',
            headStyles: { fillColor: [54, 162, 235], textColor: [255, 255, 255] },
            styles: { fontSize: 10 }
        });
        
        currentY = doc.lastAutoTable.finalY + 10;
        
        // Add other income details
        doc.setFontSize(14);
        doc.text("Other Income Sources", 14, currentY);
        currentY += 8;
        
        const incomeTable = document.getElementById("incomeTable").getElementsByTagName('tbody')[0];
        
        // Create other income table data
        const incomeHeaders = [["Income Source", "Amount (£)", "Notes"]];
        const incomeData = [];
        
        for (let i = 0; i < incomeTable.rows.length; i++) {
            const row = incomeTable.rows[i];
            incomeData.push([
                row.cells[0].getElementsByTagName('input')[0].value,
                row.cells[1].getElementsByTagName('input')[0].value,
                row.cells[2].getElementsByTagName('input')[0].value
            ]);
        }
        
        // Generate other income table
        doc.autoTable({
            startY: currentY,
            head: incomeHeaders,
            body: incomeData,
            theme: 'grid',
            headStyles: { fillColor: [255, 159, 64], textColor: [255, 255, 255] },
            styles: { fontSize: 10 }
        });
        
        currentY = doc.lastAutoTable.finalY + 10;
        
        // Add expenses details
        doc.setFontSize(14);
        doc.text("Expenses", 14, currentY);
        currentY += 8;
        
        const expenseTable = document.getElementById("expenseTable").getElementsByTagName('tbody')[0];
        
        // Create expenses table data
        const expenseHeaders = [["Category", "Expense Item", "Fixed Amount (£)", "Per Person (£)", "Notes"]];
        const expenseData = [];
        
        for (let i = 0; i < expenseTable.rows.length; i++) {
            const row = expenseTable.rows[i];
            expenseData.push([
                row.cells[0].getElementsByTagName('select')[0].value,
                row.cells[1].getElementsByTagName('input')[0].value,
                row.cells[2].getElementsByTagName('input')[0].value,
                row.cells[3].getElementsByTagName('input')[0].value,
                row.cells[4].getElementsByTagName('input')[0].value
            ]);
        }
        
        // Generate expenses table
        doc.autoTable({
            startY: currentY,
            head: expenseHeaders,
            body: expenseData,
            theme: 'grid',
            headStyles: { fillColor: [255, 99, 132], textColor: [255, 255, 255] },
            styles: { fontSize: 10 }
        });
        
        currentY = doc.lastAutoTable.finalY + 10;
        
        // Add new page if needed
        if (currentY > 240) {
            doc.addPage();
            currentY = 20;
        }
        
        // Get scenario percentages
        const scenario1 = document.getElementById("scenario1").value;
        const scenario2 = document.getElementById("scenario2").value;
        const scenario3 = document.getElementById("scenario3").value;
        const scenario4 = document.getElementById("scenario4").value;
        
        // Add financial summary
        doc.setFontSize(14);
        doc.text("Financial Summary", 14, currentY);
        currentY += 8;
        
        // Create summary table data
        const summaryHeaders = [["Category", 
            `Scenario 1 (${scenario1}%)`, 
            `Scenario 2 (${scenario2}%)`, 
            `Scenario 3 (${scenario3}%)`, 
            `Scenario 4 (${scenario4}%)`
        ]];
        
        const summaryData = [
            ["Total Ticket Income", 
                document.getElementById("summaryTicketScenario1").textContent,
                document.getElementById("summaryTicketScenario2").textContent,
                document.getElementById("summaryTicketScenario3").textContent,
                document.getElementById("summaryTicketScenario4").textContent
            ],
            ["Other Income", 
                document.getElementById("summaryOtherIncome").textContent,
                document.getElementById("summaryOtherIncome2").textContent,
                document.getElementById("summaryOtherIncome3").textContent,
                document.getElementById("summaryOtherIncome4").textContent
            ],
            ["Total Income", 
                document.getElementById("summaryTotalIncomeScenario1").textContent,
                document.getElementById("summaryTotalIncomeScenario2").textContent,
                document.getElementById("summaryTotalIncomeScenario3").textContent,
                document.getElementById("summaryTotalIncomeScenario4").textContent
            ],
            ["Total Expenses", 
                document.getElementById("summaryExpenseScenario1").textContent,
                document.getElementById("summaryExpenseScenario2").textContent,
                document.getElementById("summaryExpenseScenario3").textContent,
                document.getElementById("summaryExpenseScenario4").textContent
            ],
            ["Net Profit/Loss", 
                document.getElementById("summaryProfitScenario1").textContent,
                document.getElementById("summaryProfitScenario2").textContent,
                document.getElementById("summaryProfitScenario3").textContent,
                document.getElementById("summaryProfitScenario4").textContent
            ]
        ];
        
        // Generate summary table
        doc.autoTable({
            startY: currentY,
            head: summaryHeaders,
            body: summaryData,
            theme: 'grid',
            headStyles: { fillColor: [76, 175, 80], textColor: [255, 255, 255] },
            styles: { fontSize: 10 },
            alternateRowStyles: { fillColor: [240, 240, 240] }
        });
        
        currentY = doc.lastAutoTable.finalY + 10;
        
        // Add break-even analysis
        doc.setFontSize(14);
        doc.text("Break-Even Analysis", 14, currentY);
        currentY += 8;
        
        doc.setFontSize(11);
        doc.text(document.getElementById("breakEvenPoint").textContent, 14, currentY);
        currentY += 6;
        doc.text(document.getElementById("breakEvenRevenue").textContent, 14, currentY);
        
        // Add date of generation
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        const date = new Date().toLocaleDateString();
        doc.text(`Generated on ${date}`, 14, 285);
        
        // Save the PDF
        doc.save(eventName.replace(/\s+/g, '_') + "_Budget_Report.pdf");
        
        showNotification("Complete budget report successfully generated!");
    } catch (error) {
        console.error("PDF generation error:", error);
        showNotification("Error generating PDF. Please try again.");
    }
}
// Save current budget to local storage
function saveToLocalStorage() {
    const eventName = document.getElementById("eventName").value || "Unnamed Event";
    
    // Create an object to store all the budget data
    const budgetData = {
        eventDetails: {
            name: eventName,
            date: document.getElementById("eventDate").value,
            maxCapacity: document.getElementById("maxCapacity").value,
            scenario1: document.getElementById("scenario1").value,
            scenario2: document.getElementById("scenario2").value,
            scenario3: document.getElementById("scenario3").value,
            scenario4: document.getElementById("scenario4").value
        },
        ticketTypes: getTicketTypesData(),
        includeVAT: document.getElementById("pricesIncludeVAT").checked,
        otherIncome: getOtherIncomeData(),
        expenses: getExpensesData()
    };
    
    // Save to local storage
    localStorage.setItem(`eventBudget_${eventName}`, JSON.stringify(budgetData));
    
    // Update saved budgets list
    updateSavedBudgetsList();
    
    showNotification(`Budget for "${eventName}" saved successfully!`);
}

// Load budget from local storage
function loadFromLocalStorage(eventKey) {
    try {
        const savedData = localStorage.getItem(eventKey);
        if (!savedData) {
            showNotification("No saved budget found!");
            return;
        }
        
        const budgetData = JSON.parse(savedData);
        
        // Load event details
        loadEventDetails(budgetData.eventDetails);
        
        // Load ticket types
        loadTicketTypes(budgetData.ticketTypes);
        
        // Load VAT setting
        document.getElementById("pricesIncludeVAT").checked = budgetData.includeVAT;
        
        // Load other income
        loadOtherIncome(budgetData.otherIncome);
        
        // Load expenses
        loadExpenses(budgetData.expenses);
        
        // Recalculate everything
        calculateTicketIncome();
        calculateOtherIncome();
        calculateExpenses();
        updateSummary();
        
        showNotification("Budget loaded successfully!");
    } catch (error) {
        console.error("Error loading budget:", error);
        showNotification("Error loading budget!");
    }
}
function getTicketTypesData() {
    const ticketTable = document.getElementById("ticketTable").getElementsByTagName('tbody')[0];
    const ticketTypes = [];
    
    for (let i = 0; i < ticketTable.rows.length; i++) {
        const row = ticketTable.rows[i];
        ticketTypes.push({
            name: row.cells[0].getElementsByTagName('input')[0].value,
            price: row.cells[1].getElementsByTagName('input')[0].value,
            percentage: row.cells[2].getElementsByTagName('input')[0].value
        });
    }
    
    return ticketTypes;
}
function updateSavedBudgetsList() {
    const savedBudgets = [];
    
    // Get all keys from local storage that start with "eventBudget_"
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith("eventBudget_")) {
            savedBudgets.push(key);
        }
    }
    
    // Update dropdown with saved budgets
    const savedBudgetsSelect = document.getElementById("savedBudgetsSelect");
    savedBudgetsSelect.innerHTML = "";
    
    if (savedBudgets.length === 0) {
        const option = document.createElement("option");
        option.text = "No saved budgets";
        option.value = "";
        savedBudgetsSelect.add(option);
    } else {
        savedBudgets.forEach(budget => {
            const option = document.createElement("option");
            option.text = budget.replace("eventBudget_", "");
            option.value = budget;
            savedBudgetsSelect.add(option);
        });
    }
}
// Helper function to get other income data
function getOtherIncomeData() {
    const incomeTable = document.getElementById("incomeTable").getElementsByTagName('tbody')[0];
    const incomeItems = [];
    
    for (let i = 0; i < incomeTable.rows.length; i++) {
        const row = incomeTable.rows[i];
        incomeItems.push({
            source: row.cells[0].getElementsByTagName('input')[0].value,
            amount: row.cells[1].getElementsByTagName('input')[0].value,
            notes: row.cells[2].getElementsByTagName('input')[0].value
        });
    }
    
    return incomeItems;
}

// Helper function to get expenses data
function getExpensesData() {
    const expenseTable = document.getElementById("expenseTable").getElementsByTagName('tbody')[0];
    const expenses = [];
    
    for (let i = 0; i < expenseTable.rows.length; i++) {
        const row = expenseTable.rows[i];
        expenses.push({
            category: row.cells[0].getElementsByTagName('select')[0].value,
            item: row.cells[1].getElementsByTagName('input')[0].value,
            fixed: row.cells[2].getElementsByTagName('input')[0].value,
            perPerson: row.cells[3].getElementsByTagName('input')[0].value,
            notes: row.cells[4].getElementsByTagName('input')[0].value
        });
    }
    
    return expenses;
}

// Helper function to load event details
function loadEventDetails(details) {
    document.getElementById("eventName").value = details.name || "";
    document.getElementById("eventDate").value = details.date || "";
    document.getElementById("maxCapacity").value = details.maxCapacity || "100";
    document.getElementById("scenario1").value = details.scenario1 || "50";
    document.getElementById("scenario2").value = details.scenario2 || "70";
    document.getElementById("scenario3").value = details.scenario3 || "90";
    document.getElementById("scenario4").value = details.scenario4 || "100";
    
    // Update scenario headers
    saveEventDetails();
}

// Helper function to load ticket types
function loadTicketTypes(ticketTypes) {
    const ticketTable = document.getElementById("ticketTable").getElementsByTagName('tbody')[0];
    
    // Clear existing rows
    ticketTable.innerHTML = "";
    
    // Add each ticket type
    ticketTypes.forEach(ticket => {
        const newRow = ticketTable.insertRow();
        newRow.innerHTML = `
            <td><input type="text" value="${ticket.name || ''}"></td>
            <td><input type="number" value="${ticket.price || '0.00'}" step="0.01" min="0"></td>
            <td><input type="number" value="${ticket.percentage || '0'}" min="0" max="100"></td>
            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
        `;
    });
    
    // If no ticket types, add a default one
    if (ticketTypes.length === 0) {
        addTicketType();
    }
}

// Helper function to load other income
function loadOtherIncome(incomeItems) {
    const incomeTable = document.getElementById("incomeTable").getElementsByTagName('tbody')[0];
    
    // Clear existing rows
    incomeTable.innerHTML = "";
    
    // Add each income item
    incomeItems.forEach(income => {
        const newRow = incomeTable.insertRow();
        newRow.innerHTML = `
            <td><input type="text" value="${income.source || ''}"></td>
            <td><input type="number" value="${income.amount || '0.00'}" step="0.01" min="0"></td>
            <td><input type="text" value="${income.notes || ''}"></td>
            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
        `;
    });
    
    // If no income items, add a default one
    if (incomeItems.length === 0) {
        addIncomeSource();
    }
}

// Helper function to load expenses
function loadExpenses(expenses) {
    const expenseTable = document.getElementById("expenseTable").getElementsByTagName('tbody')[0];
    
    // Clear existing rows
    expenseTable.innerHTML = "";
    
    // Add each expense
    expenses.forEach(expense => {
        const newRow = expenseTable.insertRow();
        
        // Create the category select element
        let categoryOptions = '';
        const categories = ['Venue', 'Catering', 'Marketing', 'Entertainment', 'Staffing', 'Equipment', 'Print & Design', 'Transport', 'Other'];
        categories.forEach(category => {
            const selected = category === expense.category ? 'selected' : '';
            categoryOptions += `<option ${selected}>${category}</option>`;
        });
        
        newRow.innerHTML = `
            <td>
                <select>
                    ${categoryOptions}
                </select>
            </td>
            <td><input type="text" value="${expense.item || ''}"></td>
            <td><input type="number" value="${expense.fixed || '0.00'}" step="0.01" min="0"></td>
            <td><input type="number" value="${expense.perPerson || '0.00'}" step="0.01" min="0"></td>
            <td><input type="text" value="${expense.notes || ''}"></td>
            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
        `;
    });
    
    // If no expenses, add a default one
    if (expenses.length === 0) {
        addExpense();
    }
}
// Initialize dropdown on page load
document.addEventListener("DOMContentLoaded", function() {
    updateSavedBudgetsList();
});
// Function to delete a saved budget from local storage
function deleteSavedBudget(eventKey) {
    if (!eventKey || eventKey === "") {
        showNotification("Please select a budget to delete.");
        return;
    }
    
    try {
        // Confirm deletion
        if (confirm(`Are you sure you want to delete the budget for "${eventKey.replace('eventBudget_', '')}"?`)) {
            // Remove from local storage
            localStorage.removeItem(eventKey);
            
            // Update the dropdown
            updateSavedBudgetsList();
            
            showNotification(`Budget for "${eventKey.replace('eventBudget_', '')}" deleted successfully!`);
        }
    } catch (error) {
        console.error("Error deleting budget:", error);
        showNotification("Error deleting budget!");
    }
}
    </script>
</body>
</html>
