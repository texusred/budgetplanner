<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Budget Planner</title>
    <!-- Add jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Add js-cookie library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
        }
        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        .delete-btn {
            background-color: #f44336;
        }
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        .summary-table {
            background-color: #f8f9fa;
        }
        .positive {
            color: green;
            font-weight: bold;
        }
        .negative {
            color: red;
            font-weight: bold;
        }
        .ticket-scenarios {
            display: flex;
            margin-bottom: 15px;
        }
        .scenario-control {
            margin-right: 15px;
        }
        .attendance-row {
            background-color: #e9f7ef;
        }
        .total-row {
            background-color: #eaf2f8;
            font-weight: bold;
        }
        .tabs {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 5px 5px 0 0;
        }
        .tab-button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            margin: 0;
            color: black;
        }
        .tab-button:hover {
            background-color: #ddd;
        }
        .tab-button.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 5px 5px;
            animation: fadeEffect 1s;
        }
        @keyframes fadeEffect {
            from {opacity: 0;}
            to {opacity: 1;}
        }
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .save-btn {
            background-color: #2196F3;
        }
        .save-btn:hover {
            background-color: #0b7dda;
        }
        .load-btn {
            background-color: #ff9800;
        }
        .load-btn:hover {
            background-color: #e68a00;
        }
        .export-btn {
            background-color: #9c27b0;
        }
        .export-btn:hover {
            background-color: #7b1fa2;
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
            z-index: 100;
        }
        @media print {
            button, .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="https://raw.githubusercontent.com/your-username/your-repo/main/images/3815-ARUSU-Logo-cmyk.webp" alt="Logo">
        <h1>Event Budget Planner</h1>
        
        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'setup')">Event Setup</button>
            <button class="tab-button" onclick="openTab(event, 'tickets')">Ticket Types</button>
            <button class="tab-button" onclick="openTab(event, 'income')">Other Income</button>
            <button class="tab-button" onclick="openTab(event, 'expenses')">Expenses</button>
            <button class="tab-button" onclick="openTab(event, 'summary')">Summary</button>
        </div>
        
        <!-- Event Setup Tab -->
        <div id="setup" class="tab-content" style="display: block;">
            <div class="card">
                <h2>Event Details</h2>
                <table>
                    <tr>
                        <td>Event Name:</td>
                        <td><input type="text" id="eventName" placeholder="Enter event name"></td>
                    </tr>
                    <tr>
                        <td>Event Date:</td>
                        <td><input type="date" id="eventDate"></td>
                    </tr>
                    <tr>
                        <td>Maximum Capacity:</td>
                        <td><input type="number" id="maxCapacity" placeholder="Enter maximum attendees" value="100"></td>
                    </tr>
                </table>
                
                <h3>Attendance Scenarios</h3>
                <div class="ticket-scenarios">
                    <div class="scenario-control">
                        <label for="scenario1">Scenario 1:</label>
                        <input type="number" id="scenario1" value="50" min="1" max="100"> %
                    </div>
                    <div class="scenario-control">
                        <label for="scenario2">Scenario 2:</label>
                        <input type="number" id="scenario2" value="70" min="1" max="100"> %
                    </div>
                    <div class="scenario-control">
                        <label for="scenario3">Scenario 3:</label>
                        <input type="number" id="scenario3" value="90" min="1" max="100"> %
                    </div>
                    <div class="scenario-control">
                        <label for="scenario4">Scenario 4:</label>
                        <input type="number" id="scenario4" value="100" min="1" max="100"> %
                    </div>
                </div>
                <!--<button onclick="saveEventDetails()">Save Event Details</button>-->
            </div>
            
            <!-- New save/load buttons -->
            <div class="card">
                <h2>Save/Load Progress</h2>
                <p>You can save your progress and come back later to continue working on your budget.</p>
                <div class="action-buttons">
                    <!--<button class="save-btn" onclick="saveToCookies()">Save Progress</button>
                    <button class="load-btn" onclick="loadFromCookies()">Load Saved Progress</button>-->
                    <button class="export-btn" onclick="exportToPDF()">Export as PDF</button>
                </div>
            </div>
        </div>
        
        <!-- Ticket Types Tab -->
        <div id="tickets" class="tab-content">
            <div class="card">
                <h2>Ticket Types</h2>
                <div style="margin-bottom: 15px;">
                    <label><input type="checkbox" id="pricesIncludeVAT" checked> Ticket prices include VAT (20%)</label>
                    <p style="margin-top: 5px; color: #666; font-size: 0.9em;">Note: A transaction fee of 20p will be automatically applied per ticket sold</p>
                </div>
                <table id="ticketTable">
                    <thead>
                        <tr>
                            <th>Ticket Name</th>
                            <th>Price (£)</th>
                            <th>Expected % of Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" placeholder="e.g. Early Bird" value="Standard Ticket"></td>
                            <td><input type="number" value="25.00" step="0.01" min="0"></td>
                            <td><input type="number" value="100" min="0" max="100"></td>
                            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                        </tr>
                    </tbody>
                </table>
                <button onclick="addTicketType()">Add Ticket Type</button>
                <button onclick="calculateTicketIncome()">Calculate Ticket Income</button>
            </div>
            
            <div class="card">
                <h2>Ticket Income Projections</h2>
                <table id="ticketIncomeTable">
                    <thead>
                        <tr>
                            <th>Ticket Type</th>
                            <th id="scenario1Header">Scenario 1 (50%)</th>
                            <th id="scenario2Header">Scenario 2 (70%)</th>
                            <th id="scenario3Header">Scenario 3 (90%)</th>
                            <th id="scenario4Header">Scenario 4 (100%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- This will be populated with JavaScript -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td>Net Ticket Income</td>
                            <td id="totalTicketScenario1">£0.00</td>
                            <td id="totalTicketScenario2">£0.00</td>
                            <td id="totalTicketScenario3">£0.00</td>
                            <td id="totalTicketScenario4">£0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- Other Income Tab -->
        <div id="income" class="tab-content">
            <div class="card">
                <h2>Other Income Sources</h2>
                <table id="incomeTable">
                    <thead>
                        <tr>
                            <th>Income Source</th>
                            <th>Amount (£)</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" placeholder="e.g. Sponsorship" value="Sponsorship"></td>
                            <td><input type="number" value="500.00" step="0.01" min="0"></td>
                            <td><input type="text" placeholder="Additional details"></td>
                            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="1">Total Other Income</td>
                            <td id="totalOtherIncome">£500.00</td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
                <button onclick="addIncomeSource()">Add Income Source</button>
                <button onclick="calculateOtherIncome()">Calculate Other Income</button>
            </div>
        </div>
        
        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <div class="card">
                <h2>Expenses</h2>
                <table id="expenseTable">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Expense Item</th>
                            <th>Fixed Amount (£)</th>
                            <th>Per Person (£)</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select>
                                    <option>Venue</option>
                                    <option>Catering</option>
                                    <option>Marketing</option>
                                    <option>Entertainment</option>
                                    <option>Staffing</option>
                                    <option>Equipment</option>
                                    <option>Print & Design</option>
                                    <option>Transport</option>
                                    <option>Other</option>
                                </select>
                            </td>
                            <td><input type="text" placeholder="e.g. Venue Hire" value="Venue Hire"></td>
                            <td><input type="number" value="1000.00" step="0.01" min="0"></td>
                            <td><input type="number" value="0.00" step="0.01" min="0"></td>
                            <td><input type="text" placeholder="Additional details"></td>
                            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                        </tr>
                        <tr>
                            <td>
                                <select>
                                    <option>Venue</option>
                                    <option selected>Catering</option>
                                    <option>Marketing</option>
                                    <option>Entertainment</option>
                                    <option>Staffing</option>
                                    <option>Equipment</option>
                                    <option>Print & Design</option>
                                    <option>Transport</option>
                                    <option>Other</option>
                                </select>
                            </td>
                            <td><input type="text" placeholder="e.g. Food" value="Food"></td>
                            <td><input type="number" value="0.00" step="0.01" min="0"></td>
                            <td><input type="number" value="15.00" step="0.01" min="0"></td>
                            <td><input type="text" placeholder="Per person cost"></td>
                            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                        </tr>
                    </tbody>
                </table>
                <button onclick="addExpense()">Add Expense</button>
                <button onclick="calculateExpenses()">Calculate Expenses</button>
            </div>
            
            <div class="card">
                <h2>Expense Projections</h2>
                <table id="expenseProjectionTable">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th id="expScenario1Header">Scenario 1 (50%)</th>
                            <th id="expScenario2Header">Scenario 2 (70%)</th>
                            <th id="expScenario3Header">Scenario 3 (90%)</th>
                            <th id="expScenario4Header">Scenario 4 (100%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- This will be populated with JavaScript -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td>Total Expenses</td>
                            <td id="totalExpenseScenario1">£0.00</td>
                            <td id="totalExpenseScenario2">£0.00</td>
                            <td id="totalExpenseScenario3">£0.00</td>
                            <td id="totalExpenseScenario4">£0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- Summary Tab -->
        <div id="summary" class="tab-content">
            <div class="card">
                <h2>Budget Summary</h2>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th id="sumScenario1Header">Scenario 1 (50%)</th>
                            <th id="sumScenario2Header">Scenario 2 (70%)</th>
                            <th id="sumScenario3Header">Scenario 3 (90%)</th>
                            <th id="sumScenario4Header">Scenario 4 (100%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Gross Ticket Income</td>
                            <td id="summaryGrossTicketScenario1">£0.00</td>
                            <td id="summaryGrossTicketScenario2">£0.00</td>
                            <td id="summaryGrossTicketScenario3">£0.00</td>
                            <td id="summaryGrossTicketScenario4">£0.00</td>
                        </tr>
                        <tr>
                            <td>Less VAT (20%)</td>
                            <td id="summaryVATScenario1">£0.00</td>
                            <td id="summaryVATScenario2">£0.00</td>
                            <td id="summaryVATScenario3">£0.00</td>
                            <td id="summaryVATScenario4">£0.00</td>
                        </tr>
                        <tr>
                            <td>Less Transaction Fees (20p/ticket)</td>
                            <td id="summaryTransactionFeesScenario1">£0.00</td>
                            <td id="summaryTransactionFeesScenario2">£0.00</td>
                            <td id="summaryTransactionFeesScenario3">£0.00</td>
                            <td id="summaryTransactionFeesScenario4">£0.00</td>
                        </tr>
                        <tr>
                            <td>Net Ticket Income</td>
                            <td id="summaryTicketScenario1">£0.00</td>
                            <td id="summaryTicketScenario2">£0.00</td>
                            <td id="summaryTicketScenario3">£0.00</td>
                            <td id="summaryTicketScenario4">£0.00</td>
                        </tr>
                        <tr>
                            <td>Other Income</td>
                            <td id="summaryOtherIncome">£0.00</td>
                            <td id="summaryOtherIncome2">£0.00</td>
                            <td id="summaryOtherIncome3">£0.00</td>
                            <td id="summaryOtherIncome4">£0.00</td>
                        </tr>
                        <tr class="total-row">
                            <td>Total Income</td>
                            <td id="summaryTotalIncomeScenario1">£0.00</td>
                            <td id="summaryTotalIncomeScenario2">£0.00</td>
                            <td id="summaryTotalIncomeScenario3">£0.00</td>
                            <td id="summaryTotalIncomeScenario4">£0.00</td>
                        </tr>
                        <tr>
                            <td>Total Expenses</td>
                            <td id="summaryExpenseScenario1">£0.00</td>
                            <td id="summaryExpenseScenario2">£0.00</td>
                            <td id="summaryExpenseScenario3">£0.00</td>
                            <td id="summaryExpenseScenario4">£0.00</td>
                        </tr>
                        <tr class="total-row">
                            <td>Net Profit/Loss</td>
                            <td id="summaryProfitScenario1">£0.00</td>
                            <td id="summaryProfitScenario2">£0.00</td>
                            <td id="summaryProfitScenario3">£0.00</td>
                            <td id="summaryProfitScenario4">£0.00</td>
                        </tr>
                    </tbody>
                </table>
                
                <h3>Break-Even Analysis</h3>
                <div id="breakEvenAnalysis">
                    <p>Based on your fixed costs and per-person variable costs:</p>
                    <p id="breakEvenPoint">You need to sell <strong>0</strong> tickets to break even.</p>
                    <p id="breakEvenRevenue">This represents <strong>£0.00</strong> in revenue.</p>
                </div>
                
                <div class="chart-container">
                    <canvas id="summaryChart"></canvas>
                </div>
                
                <div class="action-buttons">
                    <button onclick="printSummary()">Print Summary</button>
                    <button onclick="exportToCSV()">Export to CSV</button>
                    <button class="export-btn" onclick="exportToPDF()">Export as PDF</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script>
        // Tab functionality
        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            
            // Hide all tab content
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            // Remove the "active" class from all tab buttons
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }
            
            // Show the current tab and add an "active" class to the button that opened the tab
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            
            // If summary tab is opened, update all calculations
            if (tabName === "summary") {
                calculateTicketIncome();
                calculateOtherIncome();
                calculateExpenses();
                updateSummary();
                updateChart();
            }
        }
        
        // Event details functions
        function saveEventDetails() {
            // Get scenario percentages and update headers
            const scenario1 = document.getElementById("scenario1").value;
            const scenario2 = document.getElementById("scenario2").value;
            const scenario3 = document.getElementById("scenario3").value;
            const scenario4 = document.getElementById("scenario4").value;
            
            // Update all scenario headers
            document.getElementById("scenario1Header").textContent = `Scenario 1 (${scenario1}%)`;
            document.getElementById("scenario2Header").textContent = `Scenario 2 (${scenario2}%)`;
            document.getElementById("scenario3Header").textContent = `Scenario 3 (${scenario3}%)`;
            document.getElementById("scenario4Header").textContent = `Scenario 4 (${scenario4}%)`;
            
            document.getElementById("expScenario1Header").textContent = `Scenario 1 (${scenario1}%)`;
            document.getElementById("expScenario2Header").textContent = `Scenario 2 (${scenario2}%)`;
            document.getElementById("expScenario3Header").textContent = `Scenario 3 (${scenario3}%)`;
            document.getElementById("expScenario4Header").textContent = `Scenario 4 (${scenario4}%)`;
            
            document.getElementById("sumScenario1Header").textContent = `Scenario 1 (${scenario1}%)`;
            document.getElementById("sumScenario2Header").textContent = `Scenario 2 (${scenario2}%)`;
            document.getElementById("sumScenario3Header").textContent = `Scenario 3 (${scenario3}%)`;
            document.getElementById("sumScenario4Header").textContent = `Scenario 4 (${scenario4}%)`;
            
            showNotification("Event details saved successfully!");
        }
        
        // Ticket functions
        function addTicketType() {
            const ticketTable = document.getElementById("ticketTable").getElementsByTagName('tbody')[0];
            const newRow = ticketTable.insertRow();
            
            newRow.innerHTML = `
                <td><input type="text" placeholder="e.g. VIP Ticket"></td>
                <td><input type="number" value="0.00" step="0.01" min="0"></td>
                <td><input type="number" value="0" min="0" max="100"></td>
                <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
            `;
        }
        
        function calculateTicketIncome() {
            const ticketTable = document.getElementById("ticketTable").getElementsByTagName('tbody')[0];
            const ticketIncomeTable = document.getElementById("ticketIncomeTable").getElementsByTagName('tbody')[0];
            const maxCapacity = parseFloat(document.getElementById("maxCapacity").value) || 100;
            const pricesIncludeVAT = document.getElementById("pricesIncludeVAT").checked;
            const VAT_RATE = 0.20; // 20% VAT
            const TRANSACTION_FEE = 0.20; // 20p per ticket
            
            // Get scenario percentages
            const scenario1 = parseFloat(document.getElementById("scenario1").value) / 100 || 0.5;
            const scenario2 = parseFloat(document.getElementById("scenario2").value) / 100 || 0.7;
            const scenario3 = parseFloat(document.getElementById("scenario3").value) / 100 || 0.9;
            const scenario4 = parseFloat(document.getElementById("scenario4").value) / 100 || 1.0;
            
            // Clear previous calculations
            ticketIncomeTable.innerHTML = "";
            
            let grossScenario1 = 0;
            let grossScenario2 = 0;
            let grossScenario3 = 0;
            let grossScenario4 = 0;
            
            let totalTicketsScenario1 = 0;
            let totalTicketsScenario2 = 0;
            let totalTicketsScenario3 = 0;
            let totalTicketsScenario4 = 0;
            
            // Calculate for each ticket type
            for (let i = 0; i < ticketTable.rows.length; i++) {
                const row = ticketTable.rows[i];
                const ticketName = row.cells[0].getElementsByTagName('input')[0].value;
                const ticketPrice = parseFloat(row.cells[1].getElementsByTagName('input')[0].value) || 0;
                const ticketPercentage = parseFloat(row.cells[2].getElementsByTagName('input')[0].value) / 100 || 0;
                
                // Calculate number of tickets for each scenario
                const maxTickets = maxCapacity * ticketPercentage;
                const scenario1Tickets = Math.floor(maxTickets * scenario1);
                const scenario2Tickets = Math.floor(maxTickets * scenario2);
                const scenario3Tickets = Math.floor(maxTickets * scenario3);
                const scenario4Tickets = Math.floor(maxTickets * scenario4);
                
                // Track total tickets
                totalTicketsScenario1 += scenario1Tickets;
                totalTicketsScenario2 += scenario2Tickets;
                totalTicketsScenario3 += scenario3Tickets;
                totalTicketsScenario4 += scenario4Tickets;
                
                // Calculate gross income
                const scenario1Income = scenario1Tickets * ticketPrice;
                const scenario2Income = scenario2Tickets * ticketPrice;
                const scenario3Income = scenario3Tickets * ticketPrice;
                const scenario4Income = scenario4Tickets * ticketPrice;
                
                // Add to gross totals
                grossScenario1 += scenario1Income;
                grossScenario2 += scenario2Income;
                grossScenario3 += scenario3Income;
                grossScenario4 += scenario4Income;
                
                // Create a new row in the ticket income table
                const newRow = ticketIncomeTable.insertRow();
                newRow.innerHTML = `
                    <td>${ticketName} (${ticketPercentage * 100}% of attendees)</td>
                    <td>£${scenario1Income.toFixed(2)} (${scenario1Tickets} tickets)</td>
                    <td>£${scenario2Income.toFixed(2)} (${scenario2Tickets} tickets)</td>
                    <td>£${scenario3Income.toFixed(2)} (${scenario3Tickets} tickets)</td>
                    <td>£${scenario4Income.toFixed(2)} (${scenario4Tickets} tickets)</td>
                `;
            }
            
            // Calculate transaction fees
            const transactionFeeScenario1 = totalTicketsScenario1 * TRANSACTION_FEE;
            const transactionFeeScenario2 = totalTicketsScenario2 * TRANSACTION_FEE;
            const transactionFeeScenario3 = totalTicketsScenario3 * TRANSACTION_FEE;
            const transactionFeeScenario4 = totalTicketsScenario4 * TRANSACTION_FEE;
            
            // Calculate VAT
            let vatScenario1, vatScenario2, vatScenario3, vatScenario4;
            
            if (pricesIncludeVAT) {
                // If prices include VAT, calculate the VAT portion
                vatScenario1 = grossScenario1 * VAT_RATE / (1 + VAT_RATE);
                vatScenario2 = grossScenario2 * VAT_RATE / (1 + VAT_RATE);
                vatScenario3 = grossScenario3 * VAT_RATE / (1 + VAT_RATE);
                vatScenario4 = grossScenario4 * VAT_RATE / (1 + VAT_RATE);
            } else {
                // If prices exclude VAT, add it on top
                vatScenario1 = grossScenario1 * VAT_RATE;
                vatScenario2 = grossScenario2 * VAT_RATE;
                vatScenario3 = grossScenario3 * VAT_RATE;
                vatScenario4 = grossScenario4 * VAT_RATE;
            }
            
            // Calculate net income
            const netScenario1 = grossScenario1 - vatScenario1 - transactionFeeScenario1;
            const netScenario2 = grossScenario2 - vatScenario2 - transactionFeeScenario2;
            const netScenario3 = grossScenario3 - vatScenario3 - transactionFeeScenario3;
            const netScenario4 = grossScenario4 - vatScenario4 - transactionFeeScenario4;
            
            // Add VAT and transaction fee rows to the ticket income table
            const vatRow = ticketIncomeTable.insertRow();
            vatRow.innerHTML = `
                <td><strong>Less VAT (20%)</strong></td>
                <td>-£${vatScenario1.toFixed(2)}</td>
                <td>-£${vatScenario2.toFixed(2)}</td>
                <td>-£${vatScenario3.toFixed(2)}</td>
                <td>-£${vatScenario4.toFixed(2)}</td>
            `;
            
            const transactionRow = ticketIncomeTable.insertRow();
            transactionRow.innerHTML = `
                <td><strong>Less Transaction Fees (20p/ticket)</strong></td>
                <td>-£${transactionFeeScenario1.toFixed(2)} (${totalTicketsScenario1} tickets)</td>
                <td>-£${transactionFeeScenario2.toFixed(2)} (${totalTicketsScenario2} tickets)</td>
                <td>-£${transactionFeeScenario3.toFixed(2)} (${totalTicketsScenario3} tickets)</td>
                <td>-£${transactionFeeScenario4.toFixed(2)} (${totalTicketsScenario4} tickets)</td>
            `;
            
            // Update totals in the ticket income table
            document.getElementById("totalTicketScenario1").textContent = `£${netScenario1.toFixed(2)}`;
            document.getElementById("totalTicketScenario2").textContent = `£${netScenario2.toFixed(2)}`;
            document.getElementById("totalTicketScenario3").textContent = `£${netScenario3.toFixed(2)}`;
            document.getElementById("totalTicketScenario4").textContent = `£${netScenario4.toFixed(2)}`;
            
            // Update summary values
            document.getElementById("summaryGrossTicketScenario1").textContent = `£${grossScenario1.toFixed(2)}`;
            document.getElementById("summaryGrossTicketScenario2").textContent = `£${grossScenario2.toFixed(2)}`;
            document.getElementById("summaryGrossTicketScenario3").textContent = `£${grossScenario3.toFixed(2)}`;
            document.getElementById("summaryGrossTicketScenario4").textContent = `£${grossScenario4.toFixed(2)}`;
            
            document.getElementById("summaryVATScenario1").textContent = `£${vatScenario1.toFixed(2)}`;
            document.getElementById("summaryVATScenario2").textContent = `£${vatScenario2.toFixed(2)}`;
            document.getElementById("summaryVATScenario3").textContent = `£${vatScenario3.toFixed(2)}`;
            document.getElementById("summaryVATScenario4").textContent = `£${vatScenario4.toFixed(2)}`;
            
            document.getElementById("summaryTransactionFeesScenario1").textContent = `£${transactionFeeScenario1.toFixed(2)}`;
            document.getElementById("summaryTransactionFeesScenario2").textContent = `£${transactionFeeScenario2.toFixed(2)}`;
            document.getElementById("summaryTransactionFeesScenario3").textContent = `£${transactionFeeScenario3.toFixed(2)}`;
            document.getElementById("summaryTransactionFeesScenario4").textContent = `£${transactionFeeScenario4.toFixed(2)}`;
            
            document.getElementById("summaryTicketScenario1").textContent = `£${netScenario1.toFixed(2)}`;
            document.getElementById("summaryTicketScenario2").textContent = `£${netScenario2.toFixed(2)}`;
            document.getElementById("summaryTicketScenario3").textContent = `£${netScenario3.toFixed(2)}`;
            document.getElementById("summaryTicketScenario4").textContent = `£${netScenario4.toFixed(2)}`;
            
            updateSummary();
        }
        
        // Income functions
        function addIncomeSource() {
            const incomeTable = document.getElementById("incomeTable").getElementsByTagName('tbody')[0];
            const newRow = incomeTable.insertRow();
            
            newRow.innerHTML = `
                <td><input type="text" placeholder="e.g. Merchandise"></td>
                <td><input type="number" value="0.00" step="0.01" min="0"></td>
                <td><input type="text" placeholder="Additional details"></td>
                <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
            `;
        }
        
        function calculateOtherIncome() {
            const incomeTable = document.getElementById("incomeTable").getElementsByTagName('tbody')[0];
            let totalIncome = 0;
            
            // Calculate total income
            for (let i = 0; i < incomeTable.rows.length; i++) {
                const row = incomeTable.rows[i];
                const incomeAmount = parseFloat(row.cells[1].getElementsByTagName('input')[0].value) || 0;
                totalIncome += incomeAmount;
            }
            
            // Update total
            document.getElementById("totalOtherIncome").textContent = `£${totalIncome.toFixed(2)}`;
            
            // Update summary values (other income is fixed across all scenarios)
            document.getElementById("summaryOtherIncome").textContent = `£${totalIncome.toFixed(2)}`;
            document.getElementById("summaryOtherIncome2").textContent = `£${totalIncome.toFixed(2)}`;
            document.getElementById("summaryOtherIncome3").textContent = `£${totalIncome.toFixed(2)}`;
            document.getElementById("summaryOtherIncome4").textContent = `£${totalIncome.toFixed(2)}`;
            
            updateSummary();
        }
        
        // Expense functions
        function addExpense() {
            const expenseTable = document.getElementById("expenseTable").getElementsByTagName('tbody')[0];
            const newRow = expenseTable.insertRow();
            
            newRow.innerHTML = `
                <td>
                    <select>
                        <option>Venue</option>
                        <option>Catering</option>
                        <option>Marketing</option>
                        <option>Entertainment</option>
                        <option>Staffing</option>
                        <option>Equipment</option>
                        <option>Print & Design</option>
                        <option>Transport</option>
                        <option>Other</option>
                    </select>
                </td>
                <td><input type="text" placeholder="e.g. Security"></td>
                <td><input type="number" value="0.00" step="0.01" min="0"></td>
                <td><input type="number" value="0.00" step="0.01" min="0"></td>
                <td><input type="text" placeholder="Additional details"></td>
                <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
            `;
        }
        
        function calculateExpenses() {
            const expenseTable = document.getElementById("expenseTable").getElementsByTagName('tbody')[0];
            const expenseProjectionTable = document.getElementById("expenseProjectionTable").getElementsByTagName('tbody')[0];
            const maxCapacity = parseFloat(document.getElementById("maxCapacity").value) || 100;
            
            // Get scenario percentages
            const scenario1 = parseFloat(document.getElementById("scenario1").value) / 100 || 0.5;
            const scenario2 = parseFloat(document.getElementById("scenario2").value) / 100 || 0.7;
            const scenario3 = parseFloat(document.getElementById("scenario3").value) / 100 || 0.9;
            const scenario4 = parseFloat(document.getElementById("scenario4").value) / 100 || 1.0;
            
            // Clear previous calculations
            expenseProjectionTable.innerHTML = "";
            
            // Create an object to group expenses by category
            const categorizedExpenses = {};
            
            // Process each expense
            for (let i = 0; i < expenseTable.rows.length; i++) {
                const row = expenseTable.rows[i];
                const category = row.cells[0].getElementsByTagName('select')[0].value;
                const itemName = row.cells[1].getElementsByTagName('input')[0].value;
                const fixedAmount = parseFloat(row.cells[2].getElementsByTagName('input')[0].value) || 0;
                const perPersonAmount = parseFloat(row.cells[3].getElementsByTagName('input')[0].value) || 0;
                
                // Initialize category if it doesn't exist
                if (!categorizedExpenses[category]) {
                    categorizedExpenses[category] = {
                        fixedTotal: 0,
                        perPersonTotal: 0,
                        items: []
                    };
                }
                
                // Add expense to category
                categorizedExpenses[category].fixedTotal += fixedAmount;
                categorizedExpenses[category].perPersonTotal += perPersonAmount;
                categorizedExpenses[category].items.push({
                    name: itemName,
                    fixed: fixedAmount,
                    perPerson: perPersonAmount
                });
            }
            
            // Calculate expense projections for each category
            let totalScenario1 = 0;
            let totalScenario2 = 0;
            let totalScenario3 = 0;
            let totalScenario4 = 0;
            
            for (const category in categorizedExpenses) {
                const expenseData = categorizedExpenses[category];
                
                // Calculate attendance for each scenario
                const scenario1Attendance = Math.floor(maxCapacity * scenario1);
                const scenario2Attendance = Math.floor(maxCapacity * scenario2);
                const scenario3Attendance = Math.floor(maxCapacity * scenario3);
                const scenario4Attendance = Math.floor(maxCapacity * scenario4);
                
                // Calculate total expenses for each scenario
                const scenario1Expense = expenseData.fixedTotal + (expenseData.perPersonTotal * scenario1Attendance);
                const scenario2Expense = expenseData.fixedTotal + (expenseData.perPersonTotal * scenario2Attendance);
                const scenario3Expense = expenseData.fixedTotal + (expenseData.perPersonTotal * scenario3Attendance);
                const scenario4Expense = expenseData.fixedTotal + (expenseData.perPersonTotal * scenario4Attendance);
                
                // Add to totals
                totalScenario1 += scenario1Expense;
                totalScenario2 += scenario2Expense;
                totalScenario3 += scenario3Expense;
                totalScenario4 += scenario4Expense;
                
                // Create a new row in the expense projection table
                const newRow = expenseProjectionTable.insertRow();
                newRow.innerHTML = `
                    <td>${category}</td>
                    <td>£${scenario1Expense.toFixed(2)}</td>
                    <td>£${scenario2Expense.toFixed(2)}</td>
                    <td>£${scenario3Expense.toFixed(2)}</td>
                    <td>£${scenario4Expense.toFixed(2)}</td>
                `;
            }
            
            // Update totals
            document.getElementById("totalExpenseScenario1").textContent = `£${totalScenario1.toFixed(2)}`;
            document.getElementById("totalExpenseScenario2").textContent = `£${totalScenario2.toFixed(2)}`;
            document.getElementById("totalExpenseScenario3").textContent = `£${totalScenario3.toFixed(2)}`;
            document.getElementById("totalExpenseScenario4").textContent = `£${totalScenario4.toFixed(2)}`;
            
            // Update summary values
            document.getElementById("summaryExpenseScenario1").textContent = `£${totalScenario1.toFixed(2)}`;
            document.getElementById("summaryExpenseScenario2").textContent = `£${totalScenario2.toFixed(2)}`;
            document.getElementById("summaryExpenseScenario3").textContent = `£${totalScenario3.toFixed(2)}`;
            document.getElementById("summaryExpenseScenario4").textContent = `£${totalScenario4.toFixed(2)}`;
            
            // Calculate and update break-even point
            calculateBreakEven();
            updateSummary();
        }
        
        function calculateBreakEven() {
            const expenseTable = document.getElementById("expenseTable").getElementsByTagName('tbody')[0];
            const ticketTable = document.getElementById("ticketTable").getElementsByTagName('tbody')[0];
            
            let fixedCosts = 0;
            let variableCostPerPerson = 0;
            
            // Calculate fixed and variable costs
            for (let i = 0; i < expenseTable.rows.length; i++) {
                const row = expenseTable.rows[i];
                fixedCosts += parseFloat(row.cells[2].getElementsByTagName('input')[0].value) || 0;
                variableCostPerPerson += parseFloat(row.cells[3].getElementsByTagName('input')[0].value) || 0;
            }
            
            // Calculate average ticket price
            let totalTicketPrice = 0;
            let totalTicketPercentage = 0;
            
            for (let i = 0; i < ticketTable.rows.length; i++) {
                const row = ticketTable.rows[i];
                const ticketPrice = parseFloat(row.cells[1].getElementsByTagName('input')[0].value) || 0;
                const ticketPercentage = parseFloat(row.cells[2].getElementsByTagName('input')[0].value) / 100 || 0;
                
                totalTicketPrice += ticketPrice * ticketPercentage;
                totalTicketPercentage += ticketPercentage;
            }
            
            const avgTicketPrice = totalTicketPercentage > 0 ? totalTicketPrice / totalTicketPercentage : 0;
            
            // Calculate break-even point
            let breakEvenTickets = 0;
            if (avgTicketPrice - variableCostPerPerson > 0) {
                breakEvenTickets = Math.ceil(fixedCosts / (avgTicketPrice - variableCostPerPerson));
            }
            
            const breakEvenRevenue = breakEvenTickets * avgTicketPrice;
            
            // Update break-even analysis
            document.getElementById("breakEvenPoint").innerHTML = `You need to sell <strong>${breakEvenTickets}</strong> tickets to break even.`;
            document.getElementById("breakEvenRevenue").innerHTML = `This represents <strong>£${breakEvenRevenue.toFixed(2)}</strong> in revenue.`;
        }
        
        // Summary functions
        function updateSummary() {
            // Get ticket income
            const ticketScenario1 = parseFloat(document.getElementById("summaryTicketScenario1").textContent.replace('£', '')) || 0;
            const ticketScenario2 = parseFloat(document.getElementById("summaryTicketScenario2").textContent.replace('£', '')) || 0;
            const ticketScenario3 = parseFloat(document.getElementById("summaryTicketScenario3").textContent.replace('£', '')) || 0;
            const ticketScenario4 = parseFloat(document.getElementById("summaryTicketScenario4").textContent.replace('£', '')) || 0;
            
            // Get other income
            const otherIncome = parseFloat(document.getElementById("summaryOtherIncome").textContent.replace('£', '')) || 0;
            
            // Get expenses
            const expenseScenario1 = parseFloat(document.getElementById("summaryExpenseScenario1").textContent.replace('£', '')) || 0;
            const expenseScenario2 = parseFloat(document.getElementById("summaryExpenseScenario2").textContent.replace('£', '')) || 0;
            const expenseScenario3 = parseFloat(document.getElementById("summaryExpenseScenario3").textContent.replace('£', '')) || 0;
            const expenseScenario4 = parseFloat(document.getElementById("summaryExpenseScenario4").textContent.replace('£', '')) || 0;
            
            // Calculate total income
            const totalIncomeScenario1 = ticketScenario1 + otherIncome;
            const totalIncomeScenario2 = ticketScenario2 + otherIncome;
            const totalIncomeScenario3 = ticketScenario3 + otherIncome;
            const totalIncomeScenario4 = ticketScenario4 + otherIncome;
            
            // Calculate profit/loss
            const profitScenario1 = totalIncomeScenario1 - expenseScenario1;
            const profitScenario2 = totalIncomeScenario2 - expenseScenario2;
            const profitScenario3 = totalIncomeScenario3 - expenseScenario3;
            const profitScenario4 = totalIncomeScenario4 - expenseScenario4;
            
            // Update summary totals
            document.getElementById("summaryTotalIncomeScenario1").textContent = `£${totalIncomeScenario1.toFixed(2)}`;
            document.getElementById("summaryTotalIncomeScenario2").textContent = `£${totalIncomeScenario2.toFixed(2)}`;
            document.getElementById("summaryTotalIncomeScenario3").textContent = `£${totalIncomeScenario3.toFixed(2)}`;
            document.getElementById("summaryTotalIncomeScenario4").textContent = `£${totalIncomeScenario4.toFixed(2)}`;
            
            // Update profit/loss with colors
            const profitElement1 = document.getElementById("summaryProfitScenario1");
            profitElement1.textContent = `£${profitScenario1.toFixed(2)}`;
            profitElement1.className = profitScenario1 >= 0 ? "positive" : "negative";
            
            const profitElement2 = document.getElementById("summaryProfitScenario2");
            profitElement2.textContent = `£${profitScenario2.toFixed(2)}`;
            profitElement2.className = profitScenario2 >= 0 ? "positive" : "negative";
            
            const profitElement3 = document.getElementById("summaryProfitScenario3");
            profitElement3.textContent = `£${profitScenario3.toFixed(2)}`;
            profitElement3.className = profitScenario3 >= 0 ? "positive" : "negative";
            
            const profitElement4 = document.getElementById("summaryProfitScenario4");
            profitElement4.textContent = `£${profitScenario4.toFixed(2)}`;
            profitElement4.className = profitScenario4 >= 0 ? "positive" : "negative";
        }
        
        function updateChart() {
            const ctx = document.getElementById('summaryChart').getContext('2d');
            
            // Get scenario percentages
            const scenario1 = document.getElementById("scenario1").value;
            const scenario2 = document.getElementById("scenario2").value;
            const scenario3 = document.getElementById("scenario3").value;
            const scenario4 = document.getElementById("scenario4").value;
            
            // Get profit/loss values
            const profitScenario1 = parseFloat(document.getElementById("summaryProfitScenario1").textContent.replace('£', '')) || 0;
            const profitScenario2 = parseFloat(document.getElementById("summaryProfitScenario2").textContent.replace('£', '')) || 0;
            const profitScenario3 = parseFloat(document.getElementById("summaryProfitScenario3").textContent.replace('£', '')) || 0;
            const profitScenario4 = parseFloat(document.getElementById("summaryProfitScenario4").textContent.replace('£', '')) || 0;
            
            // Get income values
            const incomeScenario1 = parseFloat(document.getElementById("summaryTotalIncomeScenario1").textContent.replace('£', '')) || 0;
            const incomeScenario2 = parseFloat(document.getElementById("summaryTotalIncomeScenario2").textContent.replace('£', '')) || 0;
            const incomeScenario3 = parseFloat(document.getElementById("summaryTotalIncomeScenario3").textContent.replace('£', '')) || 0;
            const incomeScenario4 = parseFloat(document.getElementById("summaryTotalIncomeScenario4").textContent.replace('£', '')) || 0;
            
            // Get expense values
            const expenseScenario1 = parseFloat(document.getElementById("summaryExpenseScenario1").textContent.replace('£', '')) || 0;
            const expenseScenario2 = parseFloat(document.getElementById("summaryExpenseScenario2").textContent.replace('£', '')) || 0;
            const expenseScenario3 = parseFloat(document.getElementById("summaryExpenseScenario3").textContent.replace('£', '')) || 0;
            const expenseScenario4 = parseFloat(document.getElementById("summaryExpenseScenario4").textContent.replace('£', '')) || 0;
            
            // Create the chart
            if (window.summaryChart) {
                window.summaryChart.destroy();
            }
            
            window.summaryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [`${scenario1}% Attendance`, `${scenario2}% Attendance`, `${scenario3}% Attendance`, `${scenario4}% Attendance`],
                    datasets: [
                        {
                            label: 'Total Income',
                            data: [incomeScenario1, incomeScenario2, incomeScenario3, incomeScenario4],
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Total Expenses',
                            data: [expenseScenario1, expenseScenario2, expenseScenario3, expenseScenario4],
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Net Profit/Loss',
                            data: [profitScenario1, profitScenario2, profitScenario3, profitScenario4],
                            backgroundColor: function(context) {
                                const value = context.dataset.data[context.dataIndex];
                                return value >= 0 ? 'rgba(75, 192, 192, 0.5)' : 'rgba(255, 159, 64, 0.5)';
                            },
                            borderColor: function(context) {
                                const value = context.dataset.data[context.dataIndex];
                                return value >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 159, 64, 1)';
                            },
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (£)'
                            }
                        }
                    }
                }
            });
        }
        
        // Utility functions
        function deleteRow(button) {
            const row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }
        
        function printSummary() {
            window.print();
        }
        
        function exportToCSV() {
            // Get event name
            const eventName = document.getElementById("eventName").value || "Event";
            
            // Prepare CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Event Budget Summary: " + eventName + "\n\n";
            
            // Get scenario percentages
            const scenario1 = document.getElementById("scenario1").value;
            const scenario2 = document.getElementById("scenario2").value;
            const scenario3 = document.getElementById("scenario3").value;
            const scenario4 = document.getElementById("scenario4").value;
            
            // Add summary data
            csvContent += "Category,Scenario 1 (" + scenario1 + "%),Scenario 2 (" + scenario2 + "%),Scenario 3 (" + scenario3 + "%),Scenario 4 (" + scenario4 + "%)\n";
            
            csvContent += "Total Ticket Income," + 
                document.getElementById("summaryTicketScenario1").textContent + "," +
                document.getElementById("summaryTicketScenario2").textContent + "," +
                document.getElementById("summaryTicketScenario3").textContent + "," +
                document.getElementById("summaryTicketScenario4").textContent + "\n";
                
            csvContent += "Other Income," + 
                document.getElementById("summaryOtherIncome").textContent + "," +
                document.getElementById("summaryOtherIncome2").textContent + "," +
                document.getElementById("summaryOtherIncome3").textContent + "," +
                document.getElementById("summaryOtherIncome4").textContent + "\n";
                
            csvContent += "Total Income," + 
                document.getElementById("summaryTotalIncomeScenario1").textContent + "," +
                document.getElementById("summaryTotalIncomeScenario2").textContent + "," +
                document.getElementById("summaryTotalIncomeScenario3").textContent + "," +
                document.getElementById("summaryTotalIncomeScenario4").textContent + "\n";
                
            csvContent += "Total Expenses," + 
                document.getElementById("summaryExpenseScenario1").textContent + "," +
                document.getElementById("summaryExpenseScenario2").textContent + "," +
                document.getElementById("summaryExpenseScenario3").textContent + "," +
                document.getElementById("summaryExpenseScenario4").textContent + "\n";
                
            csvContent += "Net Profit/Loss," + 
                document.getElementById("summaryProfitScenario1").textContent + "," +
                document.getElementById("summaryProfitScenario2").textContent + "," +
                document.getElementById("summaryProfitScenario3").textContent + "," +
                document.getElementById("summaryProfitScenario4").textContent + "\n";
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", eventName + "_Budget_Summary.csv");
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
        }
        
        // New functions for cookie-based save/load and PDF export
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            // Hide the notification after 3 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const eventName = document.getElementById("eventName").value || "Event Budget";
            
            try {
                // Create a new PDF document
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(18);
                doc.text(eventName + " - Budget Summary", 14, 22);
                
                // Add event details
                doc.setFontSize(12);
                doc.text("Event Date: " + document.getElementById("eventDate").value, 14, 32);
                doc.text("Maximum Capacity: " + document.getElementById("maxCapacity").value, 14, 38);
                
                // Add scenario percentages
                const scenario1 = document.getElementById("scenario1").value;
                const scenario2 = document.getElementById("scenario2").value;
                const scenario3 = document.getElementById("scenario3").value;
                const scenario4 = document.getElementById("scenario4").value;
                
                // Add financial summary using autoTable plugin
                doc.setFontSize(14);
                doc.text("Financial Summary", 14, 48);
                
                // Create summary table data
                const summaryData = [
                    ["Gross Ticket Income", 
                     document.getElementById("summaryGrossTicketScenario1").textContent,
                     document.getElementById("summaryGrossTicketScenario2").textContent,
                     document.getElementById("summaryGrossTicketScenario3").textContent,
                     document.getElementById("summaryGrossTicketScenario4").textContent
                    ],
                    ["Less VAT (20%)", 
                     document.getElementById("summaryVATScenario1").textContent,
                     document.getElementById("summaryVATScenario2").textContent,
                     document.getElementById("summaryVATScenario3").textContent,
                     document.getElementById("summaryVATScenario4").textContent
                    ],
                    ["Less Transaction Fees", 
                     document.getElementById("summaryTransactionFeesScenario1").textContent,
                     document.getElementById("summaryTransactionFeesScenario2").textContent,
                     document.getElementById("summaryTransactionFeesScenario3").textContent,
                     document.getElementById("summaryTransactionFeesScenario4").textContent
                    ],
                    ["Net Ticket Income", 
                     document.getElementById("summaryTicketScenario1").textContent,
                     document.getElementById("summaryTicketScenario2").textContent,
                     document.getElementById("summaryTicketScenario3").textContent,
                     document.getElementById("summaryTicketScenario4").textContent
                    ],
                    ["Other Income", 
                     document.getElementById("summaryOtherIncome").textContent,
                     document.getElementById("summaryOtherIncome2").textContent,
                     document.getElementById("summaryOtherIncome3").textContent,
                     document.getElementById("summaryOtherIncome4").textContent
                    ],
                    ["Total Income", 
                     document.getElementById("summaryTotalIncomeScenario1").textContent,
                     document.getElementById("summaryTotalIncomeScenario2").textContent,
                     document.getElementById("summaryTotalIncomeScenario3").textContent,
                     document.getElementById("summaryTotalIncomeScenario4").textContent
                    ],
                    ["Total Expenses", 
                     document.getElementById("summaryExpenseScenario1").textContent,
                     document.getElementById("summaryExpenseScenario2").textContent,
                     document.getElementById("summaryExpenseScenario3").textContent,
                     document.getElementById("summaryExpenseScenario4").textContent
                    ],
                    ["Net Profit/Loss", 
                     document.getElementById("summaryProfitScenario1").textContent,
                     document.getElementById("summaryProfitScenario2").textContent,
                     document.getElementById("summaryProfitScenario3").textContent,
                     document.getElementById("summaryProfitScenario4").textContent
                    ]
                ];
                
                // Generate table
                doc.autoTable({
                    startY: 52,
                    head: [["Category", `Scenario 1 (${scenario1}%)`, `Scenario 2 (${scenario2}%)`, `Scenario 3 (${scenario3}%)`, `Scenario 4 (${scenario4}%)`]],
                    body: summaryData,
                    theme: 'grid',
                    headStyles: { fillColor: [76, 175, 80], textColor: [255, 255, 255] },
                    styles: { fontSize: 10 },
                    alternateRowStyles: { fillColor: [240, 240, 240] }
                });
                
                // Add break-even information
                const currentY = doc.lastAutoTable.finalY + 15;
                doc.setFontSize(14);
                doc.text("Break-Even Analysis", 14, currentY);
                
                doc.setFontSize(11);
                doc.text(document.getElementById("breakEvenPoint").textContent, 14, currentY + 10);
                doc.text(document.getElementById("breakEvenRevenue").textContent, 14, currentY + 18);
                
                // Add date of generation
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                const date = new Date().toLocaleDateString();
                doc.text(`Generated on ${date}`, 14, 285);
                
                // Save the PDF
                doc.save(eventName.replace(/\s+/g, '_') + "_Budget.pdf");
                
                showNotification("PDF successfully generated!");
            } catch (error) {
                console.error("PDF generation error:", error);
                showNotification("Error generating PDF. Please try again.");
            }
        }
        
        function saveToCookies() {
            try {
                // Get event data
                const eventData = {
                    eventName: document.getElementById("eventName").value,
                    eventDate: document.getElementById("eventDate").value,
                    maxCapacity: document.getElementById("maxCapacity").value,
                    scenario1: document.getElementById("scenario1").value,
                    scenario2: document.getElementById("scenario2").value,
                    scenario3: document.getElementById("scenario3").value,
                    scenario4: document.getElementById("scenario4").value,
                    pricesIncludeVAT: document.getElementById("pricesIncludeVAT").checked,
                    
                    // Get ticket types
                    ticketTypes: [],
                    // Get other income sources
                    incomeSources: [],
                    // Get expenses
                    expenses: []
                };
                
                // Collect ticket types
                const ticketTable = document.getElementById("ticketTable").getElementsByTagName('tbody')[0];
                for (let i = 0; i < ticketTable.rows.length; i++) {
                    const row = ticketTable.rows[i];
                    eventData.ticketTypes.push({
                        name: row.cells[0].getElementsByTagName('input')[0].value,
                        price: row.cells[1].getElementsByTagName('input')[0].value,
                        percentage: row.cells[2].getElementsByTagName('input')[0].value
                    });
                }
                
                // Collect income sources
                const incomeTable = document.getElementById("incomeTable").getElementsByTagName('tbody')[0];
                for (let i = 0; i < incomeTable.rows.length; i++) {
                    const row = incomeTable.rows[i];
                    eventData.incomeSources.push({
                        name: row.cells[0].getElementsByTagName('input')[0].value,
                        amount: row.cells[1].getElementsByTagName('input')[0].value,
                        notes: row.cells[2].getElementsByTagName('input')[0].value
                    });
                }
                
                // Collect expenses
                const expenseTable = document.getElementById("expenseTable").getElementsByTagName('tbody')[0];
                for (let i = 0; i < expenseTable.rows.length; i++) {
                    const row = expenseTable.rows[i];
                    eventData.expenses.push({
                        category: row.cells[0].getElementsByTagName('select')[0].value,
                        name: row.cells[1].getElementsByTagName('input')[0].value,
                        fixedAmount: row.cells[2].getElementsByTagName('input')[0].value,
                        perPersonAmount: row.cells[3].getElementsByTagName('input')[0].value,
                        notes: row.cells[4].getElementsByTagName('input')[0].value
                    });
                }
                
                // Save to cookie (expires in 30 days)
                Cookies.set('eventBudgetData', JSON.stringify(eventData), { expires: 30 });
                
                showNotification("Your progress has been saved successfully!");
            } catch (error) {
                console.error("Save error:", error);
                showNotification("Error saving data. Please try again.");
            }
        }
        
        function loadFromCookies() {
            try {
                // Check if saved data exists
                const savedData = Cookies.get('eventBudgetData');
                
                if (!savedData) {
                    showNotification("No saved data found.");
                    return;
                }
                
                const eventData = JSON.parse(savedData);
                
                // Load event details
                document.getElementById("eventName").value = eventData.eventName || "";
                document.getElementById("eventDate").value = eventData.eventDate || "";
                document.getElementById("maxCapacity").value = eventData.maxCapacity || "100";
                document.getElementById("scenario1").value = eventData.scenario1 || "50";
                document.getElementById("scenario2").value = eventData.scenario2 || "70";
                document.getElementById("scenario3").value = eventData.scenario3 || "90";
                document.getElementById("scenario4").value = eventData.scenario4 || "100";
                document.getElementById("pricesIncludeVAT").checked = eventData.pricesIncludeVAT !== undefined ? eventData.pricesIncludeVAT : true;
                
                // Load ticket types
                const ticketTable = document.getElementById("ticketTable").getElementsByTagName('tbody')[0];
                ticketTable.innerHTML = ""; // Clear existing rows
                
                if (eventData.ticketTypes && eventData.ticketTypes.length > 0) {
                    eventData.ticketTypes.forEach(ticket => {
                        const newRow = ticketTable.insertRow();
                        newRow.innerHTML = `
                            <td><input type="text" placeholder="e.g. Early Bird" value="${ticket.name}"></td>
                            <td><input type="number" value="${ticket.price}" step="0.01" min="0"></td>
                            <td><input type="number" value="${ticket.percentage}" min="0" max="100"></td>
                            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                        `;
                    });
                } else {
                    // Add default row if no ticket types
                    const newRow = ticketTable.insertRow();
                    newRow.innerHTML = `
                        <td><input type="text" placeholder="e.g. Early Bird" value="Standard Ticket"></td>
                        <td><input type="number" value="25.00" step="0.01" min="0"></td>
                        <td><input type="number" value="100" min="0" max="100"></td>
                        <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                    `;
                }
                
                // Load income sources
                const incomeTable = document.getElementById("incomeTable").getElementsByTagName('tbody')[0];
                incomeTable.innerHTML = ""; // Clear existing rows
                
                if (eventData.incomeSources && eventData.incomeSources.length > 0) {
                    eventData.incomeSources.forEach(income => {
                        const newRow = incomeTable.insertRow();
                        newRow.innerHTML = `
                            <td><input type="text" placeholder="e.g. Sponsorship" value="${income.name}"></td>
                            <td><input type="number" value="${income.amount}" step="0.01" min="0"></td>
                            <td><input type="text" placeholder="Additional details" value="${income.notes}"></td>
                            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                        `;
                    });
                } else {
                    // Add default row if no income sources
                    const newRow = incomeTable.insertRow();
                    newRow.innerHTML = `
                        <td><input type="text" placeholder="e.g. Sponsorship" value="Sponsorship"></td>
                        <td><input type="number" value="500.00" step="0.01" min="0"></td>
                        <td><input type="text" placeholder="Additional details"></td>
                        <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                    `;
                }
                
                // Load expenses
                const expenseTable = document.getElementById("expenseTable").getElementsByTagName('tbody')[0];
                expenseTable.innerHTML = ""; // Clear existing rows
                
                if (eventData.expenses && eventData.expenses.length > 0) {
                    eventData.expenses.forEach(expense => {
                        const newRow = expenseTable.insertRow();
                        
                        // Create the select element and set the value
                        const selectOptions = ["Venue", "Catering", "Marketing", "Entertainment", "Staffing", "Equipment", "Print & Design", "Transport", "Other"];
                        let selectHtml = '<select>';
                        
                        selectOptions.forEach(option => {
                            const selected = option === expense.category ? 'selected' : '';
                            selectHtml += `<option ${selected}>${option}</option>`;
                        });
                        
                        selectHtml += '</select>';
                        
                        newRow.innerHTML = `
                            <td>${selectHtml}</td>
                            <td><input type="text" placeholder="e.g. Security" value="${expense.name}"></td>
                            <td><input type="number" value="${expense.fixedAmount}" step="0.01" min="0"></td>
                            <td><input type="number" value="${expense.perPersonAmount}" step="0.01" min="0"></td>
                            <td><input type="text" placeholder="Additional details" value="${expense.notes}"></td>
                            <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                        `;
                    });
                } else {
                    // Add default rows if no expenses
                    const defaultRow1 = expenseTable.insertRow();
                    defaultRow1.innerHTML = `
                        <td>
                            <select>
                                <option selected>Venue</option>
                                <option>Catering</option>
                                <option>Marketing</option>
                                <option>Entertainment</option>
                                <option>Staffing</option>
                                <option>Equipment</option>
                                <option>Print & Design</option>
                                <option>Transport</option>
                                <option>Other</option>
                            </select>
                        </td>
                        <td><input type="text" placeholder="e.g. Venue Hire" value="Venue Hire"></td>
                        <td><input type="number" value="1000.00" step="0.01" min="0"></td>
                        <td><input type="number" value="0.00" step="0.01" min="0"></td>
                        <td><input type="text" placeholder="Additional details"></td>
                        <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                    `;
                    
                    const defaultRow2 = expenseTable.insertRow();
                    defaultRow2.innerHTML = `
                        <td>
                            <select>
                                <option>Venue</option>
                                <option selected>Catering</option>
                                <option>Marketing</option>
                                <option>Entertainment</option>
                                <option>Staffing</option>
                                <option>Equipment</option>
                                <option>Print & Design</option>
                                <option>Transport</option>
                                <option>Other</option>
                            </select>
                        </td>
                        <td><input type="text" placeholder="e.g. Food" value="Food"></td>
                        <td><input type="number" value="0.00" step="0.01" min="0"></td>
                        <td><input type="number" value="15.00" step="0.01" min="0"></td>
                        <td><input type="text" placeholder="Per person cost"></td>
                        <td><button class="delete-btn" onclick="deleteRow(this)">Delete</button></td>
                    `;
                }
                
                // Update calculations
                saveEventDetails();
                calculateTicketIncome();
                calculateOtherIncome();
                calculateExpenses();
                updateSummary();
                
                showNotification("Your saved data has been loaded successfully!");
            } catch (error) {
                console.error("Load error:", error);
                showNotification("Error loading saved data. Please try again.");
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set default event date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('eventDate').value = today;
            
            // Calculate initial values
            saveEventDetails();
            calculateTicketIncome();
            calculateOtherIncome();
            calculateExpenses();
            updateSummary();
            
            // Check for saved data
            if (Cookies.get('eventBudgetData')) {
                showNotification("You have saved data. Click 'Load Saved Progress' to restore it.");
            }
        });
    </script>
</body>
</html>